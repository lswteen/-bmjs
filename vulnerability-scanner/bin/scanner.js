import fs from 'fs/promises';
import path from 'path';
import { CVELoader } from '../src/core/cve-loader.js';
import { ProjectScanner } from '../src/core/project-scanner.js';
import { VulnerabilityMatcher } from '../src/core/matcher.js';
import { ExcelDashboard } from '../src/core/excel-dashboard.js';
import { config } from '../src/core/config.js';

/**
 * Main scanner orchestrator
 */
export class Scanner {
    constructor(options = {}) {
        this.options = options;
        this.cveLoader = new CVELoader(options.cveBasePath, options.specificMode);
        this.projectScanner = new ProjectScanner(options.projectScanPath, options.deepScan, options.javaHome);
        this.matcher = new VulnerabilityMatcher(this.cveLoader);
        this.dashboard = new ExcelDashboard();
        this.results = null;
    }

    /**
     * Run full vulnerability scan
     */
    async scan() {
        console.log('üöÄ Starting vulnerability scan...\n');

        // Step 1: Load CVE data
        await this.cveLoader.loadAll();
        console.log('');

        // Step 2: Scan projects
        await this.projectScanner.scanDirectory();
        console.log('');

        // Step 3: Match vulnerabilities
        const projects = this.projectScanner.getProjects();
        this.results = this.matcher.matchProjects(projects);
        console.log('');

        // Step 4: Generate report
        const report = this.generateReport();
        await this.saveReport(report);

        // Step 5: Generate Excel dashboard
        await this.generateExcelDashboard(report);

        // Step 6: Print summary
        this.printSummary(report);

        return report;
    }

    /**
     * Generate comprehensive report
     */
    generateReport() {
        const stats = this.matcher.getOverallStats(this.results);

        return {
            metadata: {
                scanDate: new Date().toISOString(),
                scanner: 'vulnerability-scanner',
                version: '1.0.0'
            },
            statistics: {
                cve: this.cveLoader.getStats(),
                projects: this.projectScanner.getStats(),
                vulnerabilities: stats
            },
            projects: this.results
        };
    }

    /**
   * Generate Excel dashboard
   */
    async generateExcelDashboard(report) {
        try {
            const excelDashboard = new ExcelDashboard(report);
            await excelDashboard.generate();
        } catch (error) {
            console.warn(`‚ö†Ô∏è  Failed to generate Excel dashboard: ${error.message}`);
        }
    }

    /**
     * Save report to JSON file
     */
    async saveReport(report) {
        // Ensure output directory exists
        await fs.mkdir(config.outputDir, { recursive: true });

        const outputPath = path.join(config.outputDir, config.outputFileName);
        await fs.writeFile(outputPath, JSON.stringify(report, null, 2), 'utf8');

        console.log(`üìÑ Report saved to: ${outputPath}`);
    }

    /**
     * Print summary to console
     */
    printSummary(report) {
        const stats = report.statistics.vulnerabilities;

        console.log('\n' + '='.repeat(60));
        console.log('üìä SCAN SUMMARY');
        console.log('='.repeat(60));
        console.log(`Total Projects Scanned: ${stats.totalProjects}`);
        console.log(`Projects with Vulnerabilities: ${stats.projectsWithVulnerabilities}`);
        console.log(`Total Vulnerabilities: ${stats.totalVulnerabilities}`);
        console.log(`Unique CVEs: ${stats.uniqueCVEs}`);
        console.log('');
        console.log('Vulnerabilities by Severity:');
        console.log(`  üî¥ Critical: ${stats.bySeverity.critical}`);
        console.log(`  üü† High: ${stats.bySeverity.high}`);
        console.log(`  üü° Medium: ${stats.bySeverity.medium}`);
        console.log(`  üîµ Low: ${stats.bySeverity.low}`);
        console.log('='.repeat(60) + '\n');
    }

    /**
     * Get scan results
     */
    getResults() {
        return this.results;
    }
}
