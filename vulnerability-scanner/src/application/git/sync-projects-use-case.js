import { GitProject } from '../../domain/git/project.js';
import { GitRepository } from '../../domain/git/repository.js';

/**
 * Use Case for synchronizing Git projects and repositories (Application Layer)
 * Orchestrates the paged synchronization flow.
 */
export class SyncGitProjectsUseCase {
    constructor(gitClient, gitPersistence) {
        this.gitClient = gitClient;
        this.gitPersistence = gitPersistence;
    }

    async execute() {
        console.log('ðŸ”„ [UseCase] Starting Paged Git Synchronization...');
        let start = 0;
        const limit = 25;
        let isLastPage = false;
        let totalProjectsSynced = 0;
        let totalReposSynced = 0;
        const syncedProjectKeys = new Set();

        while (!isLastPage) {
            console.log(`ðŸ“¡ [UseCase] Fetching repos starting at index ${start}...`);
            const data = await this.gitClient.fetchReposPaged(start, limit);

            if (!data || !data.values || data.values.length === 0) {
                break;
            }

            // Group repos by project and extract project info
            const projectMap = new Map();
            data.values.forEach(repo => {
                const projectDto = repo.project;
                if (!projectDto) return;

                if (!projectMap.has(projectDto.key)) {
                    projectMap.set(projectDto.key, {
                        project: GitProject.fromDto(projectDto),
                        repositories: []
                    });
                }

                projectMap.get(projectDto.key).repositories.push(GitRepository.fromDto(repo, projectDto.key));
            });

            // Sync projects and repos for this page
            for (const [projectKey, data] of projectMap.entries()) {
                // Sync project if not already synced in this run
                if (!syncedProjectKeys.has(projectKey)) {
                    await this.gitPersistence.syncProjects([data.project]);
                    syncedProjectKeys.add(projectKey);
                    totalProjectsSynced++;
                }

                // Sync repos for this project from this page
                await this.gitPersistence.syncRepos(projectKey, data.repositories);
                totalReposSynced += data.repositories.length;
            }

            isLastPage = data.isLastPage;
            if (!isLastPage && data.nextPageStart) {
                start = data.nextPageStart;
            } else if (!isLastPage) {
                start += limit;
            }
        }

        console.log(`âœ… [UseCase] Successfully synced ${totalProjectsSynced} projects and ${totalReposSynced} repositories`);
        return {
            totalProjectsSynced,
            totalReposSynced
        };
    }
}
