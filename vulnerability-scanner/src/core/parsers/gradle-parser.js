/**
 * Parse Gradle build files (basic regex-based extraction)
 */
export class GradleParser {
    /**
     * Parse build.gradle or build.gradle.kts content
     */
    async parse(buildContent, fileName = 'build.gradle') {
        const isKotlin = fileName.endsWith('.kts');

        return {
            type: 'gradle',
            name: this.extractProjectName(buildContent) || 'unknown',
            groupId: this.extractGroup(buildContent) || 'unknown',
            artifactId: this.extractProjectName(buildContent) || 'unknown',
            version: this.extractVersion(buildContent) || '0.0.0',
            javaVersion: this.extractJavaVersion(buildContent),
            dependencies: this.extractDependencies(buildContent, isKotlin)
        };
    }

    /**
     * Extract project name from settings.gradle or build.gradle
     */
    extractProjectName(content) {
        // Try to find rootProject.name or project.name
        const namePatterns = [
            /rootProject\.name\s*=\s*['"]([^'"]+)['"]/,
            /project\.name\s*=\s*['"]([^'"]+)['"]/,
            /name\s*=\s*['"]([^'"]+)['"]/
        ];

        for (const pattern of namePatterns) {
            const match = content.match(pattern);
            if (match) return match[1];
        }

        return null;
    }

    /**
     * Extract group from build.gradle
     */
    extractGroup(content) {
        const groupPattern = /group\s*=\s*['"]([^'"]+)['"]/;
        const match = content.match(groupPattern);
        return match ? match[1] : null;
    }

    /**
     * Extract version from build.gradle
     */
    extractVersion(content) {
        const versionPattern = /version\s*=\s*['"]([^'"]+)['"]/;
        const match = content.match(versionPattern);
        return match ? match[1] : null;
    }

    /**
     * Extract Java version from build.gradle
     */
    extractJavaVersion(content) {
        // Try different patterns for Java version
        const patterns = [
            /sourceCompatibility\s*=\s*['"]?([0-9.]+)['"]?/,
            /targetCompatibility\s*=\s*['"]?([0-9.]+)['"]?/,
            /JavaVersion\.VERSION_([0-9_]+)/,
            /java\s*\{[^}]*toolchain\s*\{[^}]*languageVersion\s*=\s*JavaLanguageVersion\.of\(([0-9]+)\)/s
        ];

        for (const pattern of patterns) {
            const match = content.match(pattern);
            if (match) {
                // Handle VERSION_11, VERSION_17 format
                if (match[1].includes('_')) {
                    return match[1].replace(/_/g, '.');
                }
                return match[1];
            }
        }

        return 'unknown';
    }

    /**
     * Extract dependencies from build.gradle
     */
    extractDependencies(content, isKotlin = false) {
        const dependencies = [];

        // Patterns for different dependency formats
        const patterns = [
            // implementation 'group:artifact:version'
            /(implementation|api|compile|runtimeOnly)\s*['"]([^:'"]+):([^:'"]+):([^'"]+)['"]/g,
            // implementation("group:artifact:version") - Kotlin
            /(implementation|api|compile|runtimeOnly)\s*\(\s*['"]([^:'"]+):([^:'"]+):([^'"]+)['"]\s*\)/g,
            // implementation group: 'x', name: 'y', version: 'z'
            /(implementation|api|compile|runtimeOnly)\s+group:\s*['"]([^'"]+)['"],\s*name:\s*['"]([^'"]+)['"],\s*version:\s*['"]([^'"]+)['"]/g
        ];

        for (const pattern of patterns) {
            let match;
            while ((match = pattern.exec(content)) !== null) {
                const scope = match[1];

                // Skip test dependencies
                if (scope.toLowerCase().includes('test')) continue;

                let groupId, artifactId, version;

                if (match.length === 5) {
                    // Pattern 1 or 2
                    groupId = match[2];
                    artifactId = match[3];
                    version = match[4];
                } else if (match.length === 6) {
                    // Pattern 3
                    groupId = match[2];
                    artifactId = match[3];
                    version = match[4];
                }

                if (groupId && artifactId && version) {
                    // Skip variable references for now (e.g., ${springVersion})
                    if (!version.includes('$')) {
                        dependencies.push({
                            groupId,
                            artifactId,
                            version,
                            scope
                        });
                    }
                }
            }
        }

        return dependencies;
    }
}
