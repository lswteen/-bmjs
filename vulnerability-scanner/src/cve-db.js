import sqlite3 from 'sqlite3';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const dbPath = path.join(__dirname, '..', 'cve.db');

class CVEDatabase {
    constructor() {
        this.db = new sqlite3.Database(dbPath);
    }

    async init() {
        return new Promise((resolve, reject) => {
            this.db.serialize(() => {
                this.db.run(`
                    CREATE TABLE IF NOT EXISTS cves (
                        cveId TEXT PRIMARY KEY,
                        description TEXT,
                        cvssScore REAL,
                        severity TEXT,
                        vendor TEXT,
                        product TEXT,
                        datePublished TEXT
                    )
                `, (err) => {
                    if (err) reject(err);
                    else resolve();
                });
            });
        });
    }

    async insertCve(cve) {
        return new Promise((resolve, reject) => {
            const stmt = this.db.prepare(`
                INSERT OR REPLACE INTO cves (
                    cveId, description, cvssScore, severity, vendor, product, datePublished
                ) VALUES (?, ?, ?, ?, ?, ?, ?)
            `);
            
            stmt.run(
                cve.cveId,
                cve.description,
                cve.cvssScore,
                cve.severity,
                cve.vendor,
                cve.product,
                cve.datePublished,
                (err) => {
                    if (err) reject(err);
                    else resolve();
                }
            );
            stmt.finalize();
        });
    }

    async searchByProduct(product) {
        return new Promise((resolve, reject) => {
            this.db.all(
                "SELECT * FROM cves WHERE product LIKE ? ORDER BY cvssScore DESC LIMIT 100",
                [`%${product}%`],
                (err, rows) => {
                    if (err) reject(err);
                    else resolve(rows);
                }
            );
        });
    }

    async getStats() {
        return new Promise((resolve, reject) => {
            this.db.get("SELECT COUNT(*) as count FROM cves", (err, row) => {
                if (err) reject(err);
                else resolve(row);
            });
        });
    }

    close() {
        this.db.close();
    }
}

export const cveDb = new CVEDatabase();
