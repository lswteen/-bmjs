/**
 * Chatbot Service
 * Business logic for AI chatbot operations using vLLM
 */
export class ChatbotService {
    constructor(vllmService, cveRepository) {
        this.vllmService = vllmService;
        this.cveRepository = cveRepository;
    }

    /**
     * Process user message and generate response
     * @param {string} message - User message
     * @param {Array} conversationHistory - Previous conversation
     * @returns {Promise<string>}
     */
    async processMessage(message, conversationHistory = []) {
        // Extract CVE context if mentioned
        const cveContext = await this.extractCveContext(message);

        // Build prompt with context
        const prompt = this.buildPrompt(message, conversationHistory, cveContext);

        // Get response from vLLM
        const response = await this.vllmService.generateResponse(prompt);

        return response;
    }

    /**
     * Extract CVE context from database based on user message
     * @param {string} message - User message
     * @returns {Promise<string>}
     */
    async extractCveContext(message) {
        // Check if message mentions CVE ID (1999-2025년도 범위)
        const cveIdMatch = message.match(/CVE-(1999|20[0-1][0-9]|202[0-5])-\d+/gi);

        if (cveIdMatch && cveIdMatch.length > 0) {
            const cveId = cveIdMatch[0];
            const result = await this.cveRepository.searchByFilters({ cveId }, 1, 5);

            if (result.rows && result.rows.length > 0) {
                return this.formatCveContext(result.rows);
            }
        }

        // Check if message mentions product/vendor
        const productMatch = message.match(/\b(apache|microsoft|oracle|cisco|google|linux)\b/gi);

        if (productMatch && productMatch.length > 0) {
            const product = productMatch[0];
            const result = await this.cveRepository.searchByFilters({ product }, 1, 5);

            if (result.rows && result.rows.length > 0) {
                return this.formatCveContext(result.rows);
            }
        }

        return '';
    }

    /**
     * Format CVE data as context for the prompt
     * @param {Array} cves - CVE records
     * @returns {string}
     */
    formatCveContext(cves) {
        let context = '\n\nRelevant CVE Information:\n';

        cves.forEach(cve => {
            context += `\n- ${cve.id}: ${cve.description}`;
            if (cve.cvssScore) {
                context += ` (CVSS: ${cve.cvssScore}, Severity: ${cve.severity})`;
            }
        });

        return context;
    }

    /**
     * Build prompt with conversation history and context
     * @param {string} message - Current user message
     * @param {Array} history - Conversation history
     * @param {string} context - Additional context
     * @returns {string}
     */
    buildPrompt(message, history, context) {
        let prompt = 'You are a helpful cybersecurity assistant specializing in CVE vulnerabilities.\n\n';

        // Add conversation history
        if (history && history.length > 0) {
            prompt += 'Previous conversation:\n';
            history.forEach(item => {
                prompt += `User: ${item.user}\n`;
                prompt += `Assistant: ${item.assistant}\n`;
            });
            prompt += '\n';
        }

        // Add CVE context if available
        if (context) {
            prompt += context + '\n\n';
        }

        // Add current message
        prompt += `User: ${message}\nAssistant:`;

        return prompt;
    }

    /**
     * Get chatbot service status
     * @returns {Promise<Object>}
     */
    async getStatus() {
        const vllmStatus = await this.vllmService.checkHealth();
        const cveInitialized = this.cveRepository.isInitialized();

        return {
            vllmAvailable: vllmStatus.available,
            cveDbReady: cveInitialized,
            ready: vllmStatus.available && cveInitialized
        };
    }
}
