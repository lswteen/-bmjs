// Chatbot Logic
document.addEventListener('DOMContentLoaded', () => {
    // Render Shell
    if (typeof renderSidebar === 'function') renderSidebar('chatbot');
    if (typeof renderTopNav === 'function') renderTopNav('chatbot');

    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const typingIndicator = document.getElementById('typingIndicator');

    let conversationHistory = [];

    // Event Listeners
    sendBtn.addEventListener('click', sendMessage);
    clearBtn.addEventListener('click', clearChat);

    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    /**
     * Send message to vLLM API
     */
    async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;

        // Disable input
        chatInput.disabled = true;
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 처리중...';

        // Add user message to UI
        addMessage('user', message);
        chatInput.value = '';

        // Show typing indicator
        typingIndicator.classList.add('active');

        // Progress message for long waits
        const progressTimeout = setTimeout(() => {
            addMessage('system', 'AI가 CVE 데이터를 분석하고 있습니다. 잠시만 기다려주세요... (최대 5분)');
        }, 10000); // 10초 후 진행 상황 표시

        try {
            // Call vLLM API with no timeout (서버에서 5분 타임아웃 처리)
            const response = await fetch('/api/chatbot/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    history: conversationHistory
                })
            });

            clearTimeout(progressTimeout);

            const result = await response.json();

            if (result.success) {
                addMessage('assistant', result.response);
                conversationHistory.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content: result.response }
                );
            } else {
                addMessage('system', `오류: ${result.error || '응답을 받을 수 없습니다.'}`);
            }
        } catch (error) {
            clearTimeout(progressTimeout);
            console.error('Chatbot error:', error);
            addMessage('system', `연결 오류: ${error.message}\n\nvLLM 서버가 응답하지 않거나 네트워크 문제가 있을 수 있습니다.`);
        } finally {
            // Hide typing indicator
            typingIndicator.classList.remove('active');

            // Re-enable input
            chatInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> 전송';
            chatInput.focus();
        }
    }

    /**
     * Add message to chat UI
     */
    function addMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = content;

        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = new Date().toLocaleTimeString('ko-KR');

        messageDiv.appendChild(contentDiv);
        messageDiv.appendChild(timeDiv);

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    /**
     * Clear chat history
     */
    function clearChat() {
        if (!confirm('대화 내역을 모두 삭제하시겠습니까?')) return;

        conversationHistory = [];
        chatMessages.innerHTML = `
            <div class="message system">
                <div class="message-content">대화가 초기화되었습니다.</div>
            </div>
        `;
    }
});
