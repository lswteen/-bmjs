/**
 * CVE Controller
 * Handles HTTP requests for CVE-related operations
 * Following MVC pattern for better separation of concerns
 */
export class CveController {
    constructor(cveService) {
        this.cveService = cveService;
    }

    /**
     * Get CVEs with optional filters
     * @param {Object} req - Express request
     * @param {Object} res - Express response
     */
    async getCves(req, res) {
        try {
            if (!this.cveService.isInitialized()) {
                return res.status(503).json({
                    success: false,
                    loading: true,
                    message: 'CVE Database is still loading...'
                });
            }

            const filters = {
                product: req.query.product || '',
                cveId: req.query.cveId || '',
                severity: req.query.severity || ''
            };
            const page = parseInt(req.query.page) || 1;
            const pageSize = parseInt(req.query.pageSize) || 50;

            const result = await this.cveService.searchByFilters(filters, page, pageSize);
            res.json(result);
        } catch (error) {
            res.status(500).json({ error: error.message });
        }
    }

    /**
     * Export CVEs to Excel
     * @param {Object} req - Express request
     * @param {Object} res - Express response
     */
    async exportCves(req, res) {
        try {
            if (!this.cveService.isInitialized()) {
                return res.status(503).json({
                    success: false,
                    loading: true,
                    message: 'CVE Database is still loading...'
                });
            }

            const filters = {
                product: req.query.product || '',
                cveId: req.query.cveId || ''
            };
            const page = parseInt(req.query.page) || 1;
            const pageSize = parseInt(req.query.pageSize) || 100;

            const excelBuffer = await this.cveService.exportToExcel(filters, page, pageSize);

            res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
            res.setHeader('Content-Disposition', `attachment; filename=CVE_Export_${new Date().toISOString().split('T')[0]}.xlsx`);

            await excelBuffer.write(res);
            res.end();
        } catch (error) {
            res.status(500).json({ error: error.message });
        }
    }

    /**
     * Get filter options for visualization
     * @param {Object} req - Express request
     * @param {Object} res - Express response
     */
    async getFilterOptions(req, res) {
        try {
            const filters = await this.cveService.getFilterOptions();
            res.json({ success: true, data: filters });
        } catch (error) {
            res.status(500).json({ success: false, error: error.message });
        }
    }

    /**
     * Get CVE data for visualization
     * @param {Object} req - Express request
     * @param {Object} res - Express response
     */
    async getVisualData(req, res) {
        try {
            const { year, severity } = req.query;
            const data = await this.cveService.getVisualData(year, severity);
            res.json({ success: true, data });
        } catch (error) {
            res.status(500).json({ success: false, error: error.message });
        }
    }

    /**
     * Get detailed CVE list filtered by year and severity
     * @param {Object} req - Express request
     * @param {Object} res - Express response
     */
    async getDetailedCveList(req, res) {
        try {
            const { year, severity } = req.query;
            const page = parseInt(req.query.page) || 1;
            const pageSize = parseInt(req.query.pageSize) || 50;

            const result = await this.cveService.getDetailedCveList(year, severity, page, pageSize);
            res.json({ success: true, ...result });
        } catch (error) {
            res.status(500).json({ success: false, error: error.message });
        }
    }
}
