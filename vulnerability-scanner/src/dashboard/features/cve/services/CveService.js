import ExcelJS from 'exceljs';

/**
 * CVE Service
 * Business logic for CVE operations
 * Separates business logic from HTTP handling
 */
export class CveService {
    constructor(cveRepository) {
        this.cveRepository = cveRepository;
    }

    /**
     * Check if CVE database is initialized
     * @returns {boolean}
     */
    isInitialized() {
        return this.cveRepository.isInitialized();
    }

    /**
     * Search CVEs by filters
     * @param {Object} filters - Search filters
     * @param {number} page - Page number
     * @param {number} pageSize - Items per page
     * @returns {Promise<Object>}
     */
    async searchByFilters(filters, page, pageSize) {
        return await this.cveRepository.searchByFilters(filters, page, pageSize);
    }

    /**
     * Export CVEs to Excel format
     * @param {Object} filters - Search filters
     * @param {number} page - Page number
     * @param {number} pageSize - Items per page
     * @returns {Promise<ExcelJS.Workbook>}
     */
    async exportToExcel(filters, page, pageSize) {
        const result = await this.cveRepository.searchByFilters(filters, page, pageSize);
        const cves = result.rows || [];

        const workbook = new ExcelJS.Workbook();
        const sheet = workbook.addWorksheet('CVEs');

        // Define columns
        sheet.columns = [
            { header: 'CVE ID', key: 'id', width: 20 },
            { header: 'Description', key: 'description', width: 60 },
            { header: 'Published Date', key: 'publishedDate', width: 20 },
            { header: 'Last Modified', key: 'lastModifiedDate', width: 20 },
            { header: 'CVSS Score', key: 'cvssScore', width: 12 },
            { header: 'Severity', key: 'severity', width: 12 }
        ];

        // Add rows
        cves.forEach(cve => {
            sheet.addRow({
                id: cve.id,
                description: cve.description,
                publishedDate: cve.publishedDate,
                lastModifiedDate: cve.lastModifiedDate,
                cvssScore: cve.cvssScore,
                severity: cve.severity
            });
        });

        // Style header row
        sheet.getRow(1).font = { bold: true };
        sheet.getRow(1).fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFE0E0E0' }
        };

        return workbook;
    }

    /**
     * Get filter options for visualization
     * @returns {Promise<Object>}
     */
    async getFilterOptions() {
        return await this.cveRepository.getFilterOptions();
    }

    /**
     * Get CVE data for visualization
     * @param {string} year - Year filter
     * @param {string} severity - Severity filter
     * @returns {Promise<Array>}
     */
    async getVisualData(year, severity) {
        return await this.cveRepository.getVisualData(year, severity);
    }

    /**
     * Get detailed CVE list filtered by year and severity
     * @param {string} year - Year filter
     * @param {string} severity - Severity filter
     * @param {number} page - Page number
     * @param {number} pageSize - Items per page
     * @returns {Promise<Object>}
     */
    async getDetailedCveList(year, severity, page, pageSize) {
        return await this.cveRepository.getDetailedCveList(year, severity, page, pageSize);
    }
}
