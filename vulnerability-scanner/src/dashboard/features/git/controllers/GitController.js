/**
 * Git Controller
 * Handles HTTP requests for Git-related operations
 */
export class GitController {
    constructor(gitService) {
        this.gitService = gitService;
    }

    /**
     * Sync projects from remote Git API to local DB
     * @param {Object} req - Express request
     * @param {Object} res - Express response
     */
    async syncProjects(req, res) {
        try {
            const result = await this.gitService.syncProjects();
            res.json({
                success: true,
                count: result.totalProjectsSynced,
                repoCount: result.totalReposSynced
            });
        } catch (error) {
            res.status(500).json({ success: false, error: error.message });
        }
    }

    /**
     * Get paginated list of Git projects
     * @param {Object} req - Express request
     * @param {Object} res - Express response
     */
    async getProjects(req, res) {
        try {
            const page = parseInt(req.query.page) || 1;
            const pageSize = parseInt(req.query.pageSize) || 50;
            const result = await this.gitService.getProjects(page, pageSize);
            res.json({ success: true, ...result });
        } catch (error) {
            res.status(500).json({ success: false, error: error.message });
        }
    }

    /**
     * Get repositories for a specific project
     * @param {Object} req - Express request
     * @param {Object} res - Express response
     */
    async getRepositories(req, res) {
        try {
            const projectKey = req.params.projectKey;
            const repos = await this.gitService.getRepositories(projectKey);
            res.json({ success: true, rows: repos });
        } catch (error) {
            res.status(500).json({ success: false, error: error.message });
        }
    }

    /**
     * Export Git projects to Excel
     * @param {Object} req - Express request
     * @param {Object} res - Express response
     */
    async exportProjects(req, res) {
        try {
            const excelBuffer = await this.gitService.exportProjectsToExcel();

            res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
            res.setHeader('Content-Disposition', 'attachment; filename=gitprojects.xlsx');

            await excelBuffer.write(res);
            res.end();
        } catch (error) {
            res.status(500).json({ success: false, error: error.message });
        }
    }
}
