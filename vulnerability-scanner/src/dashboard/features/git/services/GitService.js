import ExcelJS from 'exceljs';

/**
 * Git Service
 * Business logic for Git operations
 */
export class GitService {
    constructor(gitRepository, syncUseCase) {
        this.gitRepository = gitRepository;
        this.syncUseCase = syncUseCase;
    }

    /**
     * Sync projects from remote Git API
     * @returns {Promise<Object>}
     */
    async syncProjects() {
        return await this.syncUseCase.execute();
    }

    /**
     * Get paginated list of Git projects
     * @param {number} page - Page number
     * @param {number} pageSize - Items per page
     * @returns {Promise<Object>}
     */
    async getProjects(page, pageSize) {
        return await this.gitRepository.getProjects(page, pageSize);
    }

    /**
     * Get repositories for a specific project
     * @param {string} projectKey - Project key
     * @returns {Promise<Array>}
     */
    async getRepositories(projectKey) {
        return await this.gitRepository.getRepositories(projectKey);
    }

    /**
     * Export Git projects to Excel format
     * @returns {Promise<ExcelJS.Workbook>}
     */
    async exportProjectsToExcel() {
        const result = await this.gitRepository.getProjects(1, 10000); // Fetch all for export
        const projects = result.rows;

        const workbook = new ExcelJS.Workbook();
        const sheet = workbook.addWorksheet('Git Projects');

        // Define columns
        sheet.columns = [
            { header: 'Project Key', key: 'key', width: 20 },
            { header: 'Project Name', key: 'name', width: 30 },
            { header: 'Description', key: 'description', width: 50 },
            { header: 'Public', key: 'public', width: 10 },
            { header: 'Type', key: 'type', width: 15 },
            { header: 'Link', key: 'link', width: 50 }
        ];

        // Add rows
        projects.forEach(project => {
            sheet.addRow({
                key: project.key,
                name: project.name,
                description: project.description || '',
                public: project.public ? 'Yes' : 'No',
                type: project.type || '',
                link: project.link || ''
            });
        });

        // Style header row
        sheet.getRow(1).font = { bold: true };
        sheet.getRow(1).fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFE0E0E0' }
        };

        return workbook;
    }
}
