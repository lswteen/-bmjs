import fs from 'fs/promises';
import path from 'path';

/**
 * Scan Service
 * Business logic for vulnerability scanning operations
 */
export class ScanService {
    constructor(scanner, outputPath) {
        this.scanner = scanner;
        this.outputPath = outputPath;
        this.latestResults = null;
        this.isScanning = false;
    }

    /**
     * Get latest scan results
     * @returns {Promise<Object|null>}
     */
    async getLatestResults() {
        if (this.latestResults) {
            return this.latestResults;
        }

        // Try to load from file if not in memory
        try {
            const resultsPath = path.join(this.outputPath, 'latest-scan.json');
            const data = await fs.readFile(resultsPath, 'utf-8');
            this.latestResults = JSON.parse(data);
            return this.latestResults;
        } catch (error) {
            return null;
        }
    }

    /**
     * Perform vulnerability scan
     * @returns {Promise<Object>}
     */
    async performScan() {
        if (this.isScanning) {
            throw new Error('A scan is already in progress');
        }

        try {
            this.isScanning = true;
            console.log('üîç Starting vulnerability scan...');

            const result = await this.scanner.scan();
            this.latestResults = result;

            // Save results to file
            const resultsPath = path.join(this.outputPath, 'latest-scan.json');
            await fs.writeFile(resultsPath, JSON.stringify(result, null, 2));

            console.log('‚úÖ Scan completed successfully');
            return result;
        } finally {
            this.isScanning = false;
        }
    }

    /**
     * Get scan status
     * @returns {Object}
     */
    getStatus() {
        return {
            isScanning: this.isScanning,
            hasResults: this.latestResults !== null
        };
    }

    /**
     * Get list of scanned projects
     * @returns {Promise<Array>}
     */
    async getProjects() {
        const results = await this.getLatestResults();
        if (!results || !results.projects) {
            return [];
        }
        return results.projects;
    }

    /**
     * Get vulnerabilities for a specific project
     * @param {string} projectKey - Project key
     * @returns {Promise<Array|null>}
     */
    async getProjectVulnerabilities(projectKey) {
        const projects = await this.getProjects();
        const project = projects.find(p => p.key === projectKey);
        return project ? project.vulnerabilities : null;
    }
}
