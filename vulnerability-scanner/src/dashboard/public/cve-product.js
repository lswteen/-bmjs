let selectedProducts = [];
let productChartInstance = null;

document.addEventListener('DOMContentLoaded', () => {
    renderSidebar('cve-product');
    renderTopNav('statistics');
    initFilters();
    loadProductChart();
});

async function initFilters() {
    const productContainer = document.getElementById('product-filters');

    try {
        const response = await fetch('/api/cves/visual/filters');
        const result = await response.json();

        if (result.success && result.data) {
            renderCheckboxGroup(productContainer, result.data.products, 'product');
        }
    } catch (error) {
        console.error('Failed to load filters:', error);
    }
}

function renderCheckboxGroup(container, items, type) {
    container.innerHTML = '';
    items.forEach(item => {
        const label = document.createElement('label');
        label.className = 'checkbox-item';
        label.innerHTML = `<input type="checkbox" value="${item}" data-type="${type}"> ${item}`;
        label.querySelector('input').addEventListener('change', handleFilterChange);
        container.appendChild(label);
    });
}

function handleFilterChange(e) {
    const val = e.target.value;
    const isChecked = e.target.checked;

    if (isChecked) selectedProducts.push(val);
    else selectedProducts = selectedProducts.filter(p => p !== val);

    loadProductChart();
}

async function loadProductChart() {
    const el = document.getElementById('productChart');
    try {
        const query = new URLSearchParams();
        query.set('limit', '40');

        const response = await fetch(`/api/cves/visual/product?${query.toString()}`);
        const result = await response.json();

        if (result.success && result.data) {
            let chartData = result.data.map(item => ({
                x: item.product,
                y: item.count
            }));

            if (selectedProducts.length > 0) {
                chartData = chartData.filter(item => selectedProducts.includes(item.x));
            }

            renderProductTreemap(el, chartData, 'Product Distribution (Filter: Product Checkbox)');
        } else {
            showError(el, 'Failed to load product data');
        }
    } catch (error) {
        showError(el, 'Error fetching product data');
    }
}

function renderProductTreemap(el, data, title) {
    if (productChartInstance) {
        productChartInstance.destroy();
    }
    el.innerHTML = '';

    const premiumColors = [
        '#7f1d1d', '#991b1b', '#b91c1c', '#dc2626',
        '#ef4444', '#f87171', '#fca5a5', '#fecaca',
        '#450a0a', '#742a2a', '#9b2c2c', '#c53030'
    ];

    const options = {
        series: [{
            data: data
        }],
        chart: {
            height: '100%',
            type: 'treemap',
            fontFamily: 'Inter, system-ui, sans-serif',
            toolbar: { show: true },
            background: 'transparent',
            animations: { enabled: true }
        },
        title: {
            text: title,
            align: 'left',
            style: { color: 'var(--text-primary)', fontSize: '14px', fontWeight: 600 }
        },
        stroke: {
            show: true,
            width: 2,
            colors: ['var(--bg-panel)']
        },
        colors: premiumColors,
        plotOptions: {
            treemap: {
                distributed: true,
                enableShades: false
            }
        },
        dataLabels: {
            enabled: true,
            style: {
                fontSize: '12px',
                fontWeight: '600',
                fontFamily: 'Inter, sans-serif'
            },
            offsetY: -2,
            formatter: function (text, op) {
                return [text, op.value.toLocaleString()];
            }
        },
        tooltip: {
            theme: 'dark',
            style: { fontSize: '12px' },
            y: { formatter: val => val.toLocaleString() + ' CVEs' }
        },
        legend: { show: false }
    };

    productChartInstance = new ApexCharts(el, options);
    productChartInstance.render();
}

function showError(el, msg) {
    el.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; color:var(--critical); font-size:13px;">${msg}</div>`;
}
