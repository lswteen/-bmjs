let selectedProducts = [];

document.addEventListener('DOMContentLoaded', () => {
    renderSidebar('cve-product');
    renderTopNav('statistics');
    initFilters();
    loadProductChart();
});

async function initFilters() {
    const productContainer = document.getElementById('product-filters');

    try {
        const response = await fetch('/api/cves/visual/filters');
        const result = await response.json();

        if (result.success && result.data) {
            renderCheckboxGroup(productContainer, result.data.products, 'product');
        }
    } catch (error) {
        console.error('Failed to load filters:', error);
    }
}

function renderCheckboxGroup(container, items, type) {
    container.innerHTML = '';
    items.forEach(item => {
        const label = document.createElement('label');
        label.className = 'checkbox-item';
        label.innerHTML = `<input type="checkbox" value="${item}" data-type="${type}"> ${item}`;
        label.querySelector('input').addEventListener('change', handleFilterChange);
        container.appendChild(label);
    });
}

function handleFilterChange(e) {
    const val = e.target.value;
    const isChecked = e.target.checked;

    if (isChecked) selectedProducts.push(val);
    else selectedProducts = selectedProducts.filter(p => p !== val);

    loadProductChart();
}

async function loadProductChart() {
    const el = document.getElementById('productChart');
    try {
        const query = new URLSearchParams();
        query.set('limit', '40'); // Show more on a dedicated page
        // No years here for now as requested by user's distinction but we can add back if needed
        // The previous cve-visual had cross-filtering.

        const response = await fetch(`/api/cves/visual/product?${query.toString()}`);
        const result = await response.json();

        if (result.success && result.data) {
            let chartData = result.data.map(item => ({
                x: item.product,
                y: item.count
            }));

            // If specific products are selected, we should filter or highlight?
            // Usually search means filtering.
            if (selectedProducts.length > 0) {
                chartData = chartData.filter(item => selectedProducts.includes(item.x));
            }

            renderProductTreemap(el, chartData, 'Product Distribution (Filter: Product Checkbox)');
        } else {
            showError(el, 'Failed to load product data');
        }
    } catch (error) {
        showError(el, 'Error fetching product data');
    }
}

function renderProductTreemap(el, data, title) {
    el.innerHTML = '';

    const premiumColors = [
        '#9051ff', '#3b82f6', '#1dd1a1', '#ff9f43',
        '#ff4d4d', '#feca57', '#48dbfb', '#ff9ff3',
        '#54a0ff', '#5f27cd', '#00d2d3', '#ff6b6b'
    ];

    const options = {
        series: [{
            data: data
        }],
        chart: {
            height: '100%',
            type: 'treemap',
            fontFamily: 'Inter, sans-serif',
            toolbar: { show: true },
            background: 'transparent'
        },
        title: {
            text: title,
            align: 'left',
            style: { color: 'var(--text-primary)', fontSize: '14px' }
        },
        colors: premiumColors,
        plotOptions: {
            treemap: {
                distributed: true,
                enableShades: true,
                shadeIntensity: 0.5
            }
        },
        dataLabels: {
            enabled: true,
            style: { fontSize: '12px', fontWeight: 'bold' },
            formatter: function (text, op) {
                return [text, op.value.toLocaleString()];
            }
        },
        tooltip: {
            theme: 'light',
            y: { formatter: val => val.toLocaleString() + ' CVEs' }
        }
    };

    new ApexCharts(el, options).render();
}

function showError(el, msg) {
    el.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; color:var(--critical); font-size:13px;">${msg}</div>`;
}
