let currentYear = null;
let currentSeverity = null;

document.addEventListener('DOMContentLoaded', () => {
    renderSidebar('cve-severity');
    renderTopNav('statistics');
    initYearlyBarChart();
});

async function initYearlyBarChart() {
    const el = document.getElementById('yearlyBarChart');
    try {
        const response = await fetch('/api/cves/visual/yearly-severity');
        const result = await response.json();

        if (result.success && result.data && result.data.length > 0) {
            renderYearlyStackedBar(el, result.data);

            // Auto-select latest year
            const years = [...new Set(result.data.map(item => item.year))].sort();
            const latestYear = years[years.length - 1];
            if (latestYear) {
                onYearSelected(latestYear, true); // true means initial load auto-select
            }
        } else {
            showError(el, 'Failed to load yearly data');
        }
    } catch (error) {
        showError(el, 'Error fetching yearly data');
    }
}

function renderYearlyStackedBar(el, data) {
    el.innerHTML = '';

    const yearGroups = {};
    data.forEach(item => {
        if (!yearGroups[item.year]) yearGroups[item.year] = { CRITICAL: 0, HIGH: 0, MEDIUM: 0, LOW: 0 };
        yearGroups[item.year][item.severity] = item.count;
    });

    const years = Object.keys(yearGroups).sort();
    const series = [
        { name: 'CRITICAL', data: years.map(y => yearGroups[y].CRITICAL), color: getSeverityColor('CRITICAL') },
        { name: 'HIGH', data: years.map(y => yearGroups[y].HIGH), color: getSeverityColor('HIGH') },
        { name: 'MEDIUM', data: years.map(y => yearGroups[y].MEDIUM), color: getSeverityColor('MEDIUM') },
        { name: 'LOW', data: years.map(y => yearGroups[y].LOW), color: getSeverityColor('LOW') }
    ];

    const options = {
        series: series,
        chart: {
            type: 'bar',
            height: 440,
            stacked: true,
            toolbar: { show: false },
            events: {
                dataPointSelection: (event, chartContext, config) => {
                    const year = years[config.dataPointIndex];
                    onYearSelected(year);
                }
            },
            animations: { enabled: true }
        },
        plotOptions: { bar: { horizontal: false, columnWidth: '85%', borderRadius: 2 } },
        xaxis: { categories: years, labels: { rotate: -45, style: { colors: '#64748b', fontSize: '10px' } } },
        yaxis: { labels: { style: { colors: '#64748b' } } },
        legend: { position: 'top', horizontalAlign: 'right', labels: { colors: 'var(--text-primary)' } },
        fill: { opacity: 0.9 },
        theme: { mode: localStorage.getItem('theme') || 'light' },
        tooltip: { theme: localStorage.getItem('theme') === 'dark' ? 'dark' : 'light' }
    };

    new ApexCharts(el, options).render();
}

function onYearSelected(year, isInitial = false) {
    currentYear = year;
    currentSeverity = null;
    document.getElementById('treemapTitle').textContent = `2. ${year} Severity Distribution Map (Click block for list)`;
    loadYearTreemap(year, isInitial);
}

async function loadYearTreemap(year, isInitial = false) {
    const el = document.getElementById('yearScoreChart');
    el.innerHTML = '<div class="loading"><div class="spinner"></div><p>데이터 분석 중...</p></div>';

    try {
        const response = await fetch(`/api/cves/visual/year-score?years=${year}`);
        const result = await response.json();

        if (result.success && result.data && result.data.length > 0) {
            renderTreemap(el, result.data, `${year} Risk Profile`);

            // Auto-select CRITICAL or first available severity
            const priority = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW'];
            const available = result.data.map(d => d.severity);
            const defaultSeverity = priority.find(p => available.includes(p)) || available[0];
            if (defaultSeverity) {
                onSeveritySelected(defaultSeverity);
            }
        } else {
            showError(el, 'Failed to load year details');
        }
    } catch (error) {
        showError(el, 'Error fetching year details');
    }
}

function renderTreemap(el, data, title) {
    el.innerHTML = '';

    const options = {
        series: [{
            data: data.map(item => ({
                x: item.severity,
                y: item.count,
                fillColor: getSeverityColor(item.severity)
            }))
        }],
        chart: {
            height: 440,
            type: 'treemap',
            events: {
                dataPointSelection: (event, chartContext, config) => {
                    const sev = data[config.dataPointIndex].severity;
                    onSeveritySelected(sev);
                }
            },
            toolbar: { show: true }
        },
        theme: { mode: localStorage.getItem('theme') || 'light' },
        plotOptions: {
            treemap: {
                distributed: true,
                enableShades: true,
                shadeIntensity: 0.5
            }
        },
        dataLabels: {
            enabled: true,
            style: { fontSize: '14px', fontWeight: '700', fontFamily: 'inherit' },
            formatter: (text, op) => {
                return [text, op.value.toLocaleString() + ' CVEs'];
            }
        },
        tooltip: {
            theme: localStorage.getItem('theme') === 'dark' ? 'dark' : 'light',
            y: { formatter: val => val.toLocaleString() + ' Vulnerabilities' }
        }
    };

    new ApexCharts(el, options).render();
}

function onSeveritySelected(severity) {
    currentSeverity = severity;
    document.getElementById('listTitle').textContent = `3. CVE List: ${currentYear} [${severity}] (Top 50)`;
    loadCveDetails(currentYear, severity);
}

async function loadCveDetails(year, severity) {
    const tbody = document.getElementById('cveTableBody');
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">데이터를 불러오는 중...</td></tr>';

    try {
        const response = await fetch(`/api/cves/visual/severity-list?year=${year}&severity=${severity}&limit=50`);
        const result = await response.json();

        if (result.success && result.data) {
            renderCveTable(result.data);
        }
    } catch (err) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--critical);">데이터 로딩 실패</td></tr>';
    }
}

function renderCveTable(rows) {
    const tbody = document.getElementById('cveTableBody');
    tbody.innerHTML = '';

    if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">취약점이 없습니다.</td></tr>';
        return;
    }

    rows.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="vuln-id" style="font-weight:700; color:var(--text-primary);">${row.cveId}</td>
            <td><span class="severity-badge ${row.severity ? row.severity.toLowerCase() : 'unknown'}">${row.severity || 'UNKNOWN'}</span></td>
            <td class="severity-col ${row.severity ? row.severity.toLowerCase() : 'unknown'}" style="font-weight:700;">${row.cvssScore}</td>
            <td>${row.product}</td>
            <td>${row.vendor || '-'}</td>
            <td style="font-size:12px; color:var(--text-secondary);">${row.datePublished ? row.datePublished.split('T')[0] : '-'}</td>
            <td style="max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:12px;" title="${row.description}">${row.description}</td>
        `;
        tbody.appendChild(tr);
    });
}

function getSeverityColor(severity) {
    const computedStyle = getComputedStyle(document.documentElement);
    const colors = {
        'CRITICAL': computedStyle.getPropertyValue('--critical').trim() || '#dc2626',
        'HIGH': computedStyle.getPropertyValue('--high').trim() || '#ea580c',
        'MEDIUM': computedStyle.getPropertyValue('--medium').trim() || '#d97706',
        'LOW': computedStyle.getPropertyValue('--low').trim() || '#16a34a',
        'DEFAULT': computedStyle.getPropertyValue('--info').trim() || '#3182ce'
    };
    return colors[severity] || colors['DEFAULT'];
}

function getSeverityColorByScore(score) {
    if (score >= 9.0) return '#ff4d4d';
    if (score >= 7.0) return '#ff9f43';
    if (score >= 4.0) return '#feca57';
    return '#1dd1a1';
}

function showError(el, msg) {
    el.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; color:var(--critical); font-size:13px;">${msg}</div>`;
}
