// Git Projects Dashboard Logic
document.addEventListener('DOMContentLoaded', () => {
    // Render Shell (Sidebar / TopNav)
    if (typeof renderSidebar === 'function') renderSidebar('git-projects');
    if (typeof renderTopNav === 'function') {
        renderTopNav('git', `
            <button id="syncBtn" class="btn btn-primary small"><i class="fas fa-sync"></i> GitSync</button>
            <button id="exportBtn" class="btn btn-secondary small"><i class="fas fa-file-excel"></i> Export</button>
        `);
    }

    // UI Elements (These must exist AFTER renderTopNav)
    const syncBtn = document.getElementById('syncBtn');
    const exportBtn = document.getElementById('exportBtn');
    const tableBody = document.getElementById('projectTableBody');
    const totalCountEl = document.getElementById('totalProjectCount');
    const lastSyncEl = document.getElementById('lastSyncTime');
    const paginationEl = document.getElementById('pagination');

    let currentPage = 1;
    const pageSize = 25;

    // Initial Load
    loadProjects(currentPage);

    // Event Listeners
    syncBtn.addEventListener('click', handleSync);
    exportBtn.addEventListener('click', handleExport);

    /**
     * Fetch and render projects from local API
     */
    async function loadProjects(page) {
        tableBody.innerHTML = '<tr><td colspan="5" class="loading-cell"><div class="spinner-sm"></div> 데이터 로딩 중...</td></tr>';

        try {
            const response = await fetch(`/api/git/projects?page=${page}&pageSize=${pageSize}`);
            const result = await response.json();

            if (result.success) {
                // If no data exists and this is the first page, auto-sync
                if (result.total === 0 && page === 1) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="loading-cell"><div class="spinner-sm"></div> 데이터가 없습니다. 자동으로 Git 동기화를 시작합니다...</td></tr>';
                    await handleSync();
                    // Reload after sync
                    await loadProjects(1);
                    return;
                }

                renderTable(result.rows, (page - 1) * pageSize);
                renderPagination(result.total, page);
                totalCountEl.textContent = result.total.toLocaleString();

                if (result.rows.length > 0 && result.rows[0].lastSynced) {
                    const date = new Date(result.rows[0].lastSynced);
                    lastSyncEl.textContent = date.toLocaleString();
                }
            } else {
                showError(result.message);
            }
        } catch (error) {
            showError('데이터를 불러오는 데 실패했습니다.');
        }
    }

    /**
     * Render data rows to table
     */
    function renderTable(projects, startIndex) {
        if (!projects || projects.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px; color: var(--text-muted);">동기화된 프로젝트가 없습니다. <br> GitSync를 클릭하여 데이터를 가져오세요.</td></tr>';
            return;
        }

        tableBody.innerHTML = '';
        projects.forEach((p, idx) => {
            const tr = document.createElement('tr');
            tr.classList.add('project-row');
            tr.dataset.key = p.key;
            const syncDate = p.lastSynced ? p.lastSynced.replace('T', ' ').split('.')[0] : '-';

            tr.innerHTML = `
                <td class="col-no">${startIndex + idx + 1}</td>
                <td class="col-name" style="font-weight: 600; color: var(--text-primary);" title="${p.name || ''}">${p.name || '-'}</td>
                <td class="col-key vuln-id" title="${p.key || ''}">${p.key || '-'}</td>
                <td class="col-desc" style="font-size: 13px; color: var(--text-secondary);" title="${p.description || ''}">${p.description || '-'}</td>
                <td class="col-sync" style="font-size: 12px; color: var(--text-muted);">${syncDate}</td>
            `;

            tr.addEventListener('click', () => toggleRepos(tr, p.key));
            tableBody.appendChild(tr);

            // Detail row (hidden by default)
            const detailTr = document.createElement('tr');
            detailTr.id = `repos-${p.key}`;
            detailTr.classList.add('repos-row', 'hidden');
            detailTr.innerHTML = `
                <td colspan="5" class="repos-container">
                    <div class="repos-loading"><i class="fas fa-spinner fa-spin"></i> Loading repositories...</div>
                    <ul class="repos-list"></ul>
                </td>
            `;
            tableBody.appendChild(detailTr);
        });
    }

    /**
     * Toggle visibility of repositories for a project
     */
    async function toggleRepos(row, projectKey) {
        const detailRow = document.getElementById(`repos-${projectKey}`);
        const isHidden = detailRow.classList.contains('hidden');

        // Close others
        document.querySelectorAll('.repos-row').forEach(r => {
            if (r.id !== `repos-${projectKey}`) r.classList.add('hidden');
        });
        document.querySelectorAll('.project-row').forEach(r => {
            if (r !== row) r.classList.remove('expanded');
        });

        if (isHidden) {
            detailRow.classList.remove('hidden');
            row.classList.add('expanded');

            const listEl = detailRow.querySelector('.repos-list');
            const loadingEl = detailRow.querySelector('.repos-loading');

            if (listEl.children.length === 0) {
                loadingEl.style.display = 'block';
                listEl.style.display = 'none';

                try {
                    const response = await fetch(`/api/git/repos?projectKey=${projectKey}`);
                    const result = await response.json();

                    if (result.success && result.rows.length > 0) {
                        listEl.innerHTML = result.rows.map(repo => `
                            <li>
                                <span class="repo-name">${repo.name}</span>
                                <span class="repo-sep">|</span>
                                <span class="repo-desc">${repo.description || '<span class="no-desc">No description</span>'}</span>
                            </li>
                        `).join('');
                        loadingEl.style.display = 'none';
                        listEl.style.display = 'block';
                    } else {
                        loadingEl.innerHTML = '<i class="fas fa-info-circle"></i> No repositories found. Try syncing first.';
                    }
                } catch (error) {
                    loadingEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Failed to load repositories.';
                }
            }
        } else {
            detailRow.classList.add('hidden');
            row.classList.remove('expanded');
        }
    }

    /**
     * Handle Git API Sync
     */
    async function handleSync() {
        syncBtn.disabled = true;
        const originalText = syncBtn.innerHTML;
        syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';

        try {
            const response = await fetch('/api/git/sync', { method: 'POST' });
            const result = await response.json();

            if (result.success) {
                alert(`${result.count}개의 프로젝트가 성공적으로 동기화되었습니다.`);
                currentPage = 1;
                loadProjects(currentPage);
            } else {
                alert(`동기화 실패: ${result.error}`);
            }
        } catch (error) {
            alert('동기화 중 오류가 발생했습니다.');
        } finally {
            syncBtn.disabled = false;
            syncBtn.innerHTML = originalText;
        }
    }

    /**
     * Handle Excel Export
     */
    function handleExport() {
        window.location.href = '/api/git/export';
    }

    /**
     * Render Pagination Controls
     */
    function renderPagination(total, page) {
        const totalPages = Math.ceil(total / pageSize);
        if (totalPages <= 1) {
            paginationEl.innerHTML = '';
            return;
        }

        let html = '';
        const maxButtons = 5;
        let startPage = Math.max(1, page - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);

        if (endPage - startPage + 1 < maxButtons) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }

        // Prev
        html += `<button class="page-btn" ${page === 1 ? 'disabled' : ''} data-page="${page - 1}"><i class="fas fa-chevron-left"></i></button>`;

        for (let i = startPage; i <= endPage; i++) {
            html += `<button class="page-btn ${i === page ? 'active' : ''}" data-page="${i}">${i}</button>`;
        }

        // Next
        html += `<button class="page-btn" ${page === totalPages ? 'disabled' : ''} data-page="${page + 1}"><i class="fas fa-chevron-right"></i></button>`;

        paginationEl.innerHTML = html;

        paginationEl.querySelectorAll('.page-btn:not([disabled])').forEach(btn => {
            btn.addEventListener('click', () => {
                currentPage = parseInt(btn.dataset.page);
                loadProjects(currentPage);
            });
        });
    }

    function showError(msg) {
        tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: var(--critical); padding: 40px;">${msg}</td></tr>`;
    }
});
