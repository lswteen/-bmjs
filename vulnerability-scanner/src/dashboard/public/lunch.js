const restaurants = [
    { name: "광화문 미진", type: "메밀국수" },
    { name: "오제제", type: "돈까스/우동" },
    { name: "후니도니", type: "돈까스" },
    { name: "무교동 북어국집", type: "한식" },
    { name: "허니떡볶이", type: "분식" },
    { name: "이치규", type: "일식/규카츠" },
    { name: "코끼리초밥", type: "일식/초밥" },
    { name: "고청담", type: "한우" },
    { name: "우아라", type: "한우 오마카세" },
    { name: "장호왕곱창", type: "김치찌개" },
    { name: "안동국시", type: "한식/국수" },
    { name: "화목순대국", type: "국밥" },
    { name: "송백부대찌개", type: "부대찌개" },
    { name: "문화수제비", type: "한식" },
    { name: "꼬꼬뚝닭", type: "닭요리" },
    { name: "광화문뚝감", type: "감자탕" },
    { name: "평안도만두집", type: "만두" },
    { name: "청진옥", type: "해장국" },
    { name: "우육면관", type: "중식/우육면" },
    { name: "뽐모도로", type: "양식/파스타" }
];

const canvas = document.getElementById('rouletteCanvas');
const ctx = canvas.getContext('2d');
const spinBtn = document.getElementById('spinBtn');
const resultModal = document.getElementById('resultModal');
const resultName = document.getElementById('resultName');
const resultType = document.getElementById('resultType');

let currentRotation = 0;
let isSpinning = false;
const colors = [
    '#e03131', '#c92a2a', '#e8590c', '#d9480f', 
    '#fcc419', '#fab005', '#94d82d', '#82c91e', 
    '#40c057', '#37b24d', '#228be6', '#1c7ed6', 
    '#5c7cfa', '#4c6ef5', '#be4bdb', '#ae3ec9', 
    '#f783ac', '#e64980', '#212529', '#343a40'
];

// Helper to shuffle colors if needed, but let's just cycle them
const segmentAngle = (2 * Math.PI) / restaurants.length;

function init() {
    renderList();
    drawWheel();
    
    spinBtn.addEventListener('click', spin);
}

function renderList() {
    const list = document.getElementById('restaurantList');
    restaurants.forEach(r => {
        const li = document.createElement('li');
        li.className = 'restaurant-item';
        li.innerHTML = `
            <span class="restaurant-name">${r.name}</span>
            <span class="restaurant-type">${r.type}</span>
        `;
        list.appendChild(li);
    });
}

function drawWheel() {
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = canvas.width / 2 - 10; // Padding

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Save context to rotate entire wheel
    ctx.save();
    ctx.translate(centerX, centerY);
    ctx.rotate(currentRotation);
    ctx.translate(-centerX, -centerY);

    for (let i = 0; i < restaurants.length; i++) {
        const angle = i * segmentAngle; // Start angle for this segment
        
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, angle, angle + segmentAngle);
        ctx.closePath();

        // Alternating colors or specific palette
        ctx.fillStyle = i % 2 === 0 ? '#343a40' : '#495057'; // Dark theme slate colors
        // Or easier visibility:
        ctx.fillStyle = colors[i % colors.length];
        
        ctx.fill();
        ctx.stroke();

        // Text
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(angle + segmentAngle / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#ffffff";
        ctx.font = "bold 12px Arial";
        ctx.fillText(restaurants[i].name, radius - 20, 5); // 10px offset
        ctx.restore();
    }
    
    ctx.restore();
}

function spin() {
    if (isSpinning) return;
    isSpinning = true;
    spinBtn.disabled = true;
    resultModal.classList.remove('show');

    // Random rotation between 5 and 10 full circles + random offset
    const randomRotations = 5 + Math.random() * 5; 
    const totalRotation = randomRotations * 2 * Math.PI;
    
    const duration = 4000; // ms
    const startTime = performance.now();
    const startRotation = currentRotation;

    function animate(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Ease out quint
        const ease = 1 - Math.pow(1 - progress, 5);
        
        currentRotation = startRotation + totalRotation * ease;
        drawWheel();

        if (progress < 1) {
            requestAnimationFrame(animate);
        } else {
            isSpinning = false;
            spinBtn.disabled = false;
            showResult();
        }
    }

    requestAnimationFrame(animate);
}

function showResult() {
    // Calculate which segment is at the TOP (angle 3/2 PI or -1/2 PI)
    // Since canvas 0 is at 3 o'clock, top is -90deg or 270deg.
    // However, our arrow is at the TOP.
    // The rotation is applied to the context.
    
    // Normalize rotation to 0 - 2PI
    const normalizedRotation = currentRotation % (2 * Math.PI);
    
    // The pointer is at -PI/2 (top). 
    // To find the segment, we need to reverse logical rotation.
    // Angle pointing up relative to the rotated wheel is: -PI/2 - rotation
    let pointerAngle = (1.5 * Math.PI) - normalizedRotation; // 270deg is top
    
    // Normalize pointer angle to positive 0 - 2PI
    while (pointerAngle < 0) pointerAngle += 2 * Math.PI;
    pointerAngle %= 2 * Math.PI;

    const index = Math.floor(pointerAngle / segmentAngle);
    const winner = restaurants[index];

    resultName.textContent = winner.name;
    resultType.textContent = winner.type;
    resultModal.classList.add('show');
}

// Start
init();
