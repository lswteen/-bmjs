// Tree Map Visualization
document.addEventListener('DOMContentLoaded', init);

let allProjectsData = [];

const MOCK_DATA = {
    projects: [
        {
            project: { name: "Ecommerce Backend", key: "com.example:ecommerce-backend", type: "maven", artifactId: "ecommerce-backend", javaVersion: "17" },
            vulnerabilities: [
                { cveId: "CVE-2023-44487", description: "Rapid Reset Attack vulnerability in HTTP/2 protocol functionality.", cvss: { severity: "CRITICAL", score: 9.8 }, dependency: { groupId: "io.netty", artifactId: "netty-handler", version: "4.1.99.Final" } },
                { cveId: "CVE-2023-34050", description: "Spring AMQP Serialization Vulnerability.", cvss: { severity: "HIGH", score: 8.1 }, dependency: { groupId: "org.springframework.amqp", artifactId: "spring-amqp", version: "2.4.10" } }
            ],
            summary: { critical: 1, high: 1, medium: 2, low: 5, total: 9 },
            dependencies: { direct: 45, transitive: 128 }
        },
        {
            project: { name: "Customer Portal", key: "com.example:customer-portal", type: "gradle", artifactId: "customer-portal", javaVersion: "11" },
            vulnerabilities: [],
            summary: { critical: 0, high: 0, medium: 1, low: 3, total: 4 },
            dependencies: { direct: 22, transitive: 86 }
        },
        {
            project: { name: "Payment Gateway", key: "com.example:payment-gateway", type: "maven", artifactId: "payment-service", javaVersion: "21" },
            vulnerabilities: [
                { cveId: "CVE-2022-1471", description: "SnakeYAML Constructor Remote Code Execution.", cvss: { severity: "CRITICAL", score: 9.9 }, dependency: { groupId: "org.yaml", artifactId: "snakeyaml", version: "1.33" } }
            ],
            summary: { critical: 1, high: 0, medium: 0, low: 1, total: 2 },
            dependencies: { direct: 18, transitive: 42 }
        },
        {
            project: { name: "Inventory System", key: "com.example:inventory-sys", type: "ant", artifactId: "inventory-core", javaVersion: "8" },
            vulnerabilities: [],
            summary: { critical: 5, high: 8, medium: 15, low: 20, total: 48 },
            dependencies: { direct: 82, transitive: 250 }
        },
        {
            project: { name: "Auth Service", key: "com.example:auth-service", type: "maven", artifactId: "auth-service", javaVersion: "17" },
            vulnerabilities: [],
            summary: { critical: 0, high: 0, medium: 0, low: 0, total: 0 },
            dependencies: { direct: 15, transitive: 35 }
        },
        {
            project: { name: "Search Engine", key: "com.example:search-engine", type: "maven", artifactId: "search-api", javaVersion: "11" },
            vulnerabilities: [
                { cveId: "CVE-2021-44228", description: "Log4j Remote Code Execution (Log4Shell).", cvss: { severity: "CRITICAL", score: 10.0 }, dependency: { groupId: "org.apache.logging.log4j", artifactId: "log4j-core", version: "2.14.1" } }
            ],
            summary: { critical: 2, high: 3, medium: 1, low: 0, total: 6 },
            dependencies: { direct: 10, transitive: 50 }
        },
        {
            project: { name: "Reporting Tool", key: "com.example:reporting-tool", type: "gradle", artifactId: "reports-app", javaVersion: "17" },
            vulnerabilities: [],
            summary: { critical: 0, high: 2, medium: 4, low: 10, total: 16 },
            dependencies: { direct: 30, transitive: 110 }
        },
        {
            project: { name: "Data Pipeline", key: "com.example:data-pipeline", type: "maven", artifactId: "data-ingest", javaVersion: "11" },
            vulnerabilities: [],
            summary: { critical: 1, high: 5, medium: 2, low: 0, total: 8 },
            dependencies: { direct: 25, transitive: 90 }
        },
        {
            project: { name: "Mobile API", key: "com.example:mobile-api", type: "maven", artifactId: "mobile-backend", javaVersion: "17" },
            vulnerabilities: [],
            summary: { critical: 0, high: 1, medium: 3, low: 2, total: 6 },
            dependencies: { direct: 12, transitive: 45 }
        },
        {
            project: { name: "Admin Dashboard", key: "com.example:admin-dash", type: "gradle", artifactId: "admin-ui", javaVersion: "17" },
            vulnerabilities: [],
            summary: { critical: 0, high: 0, medium: 1, low: 0, total: 1 },
            dependencies: { direct: 8, transitive: 30 }
        }
    ]
};

async function init() {
    try {
        const response = await fetch('/api/results');

        let loadedData;

        if (!response.ok) {
            console.warn('API fetch failed, falling back to MOCK_DATA');
            loadedData = MOCK_DATA;
        } else {
            const result = await response.json();
            if (result.success && result.data) {
                loadedData = result.data;
                // If live data empty, use mock
                if (!loadedData.projects || loadedData.projects.length === 0) {
                    loadedData = MOCK_DATA;
                }
            } else {
                console.warn('API returned success:false, falling back to MOCK_DATA');
                loadedData = MOCK_DATA;
            }
        }

        allProjectsData = loadedData.projects;

        // Check for drill-down param
        const urlParams = new URLSearchParams(window.location.search);
        const projectKey = urlParams.get('project');

        if (projectKey) {
            renderProjectDetail(projectKey);
        } else {
            renderGlobalView();
        }

    } catch (error) {
        console.error('Failed to load results, using MOCK_DATA:', error);
        allProjectsData = MOCK_DATA.projects;
        renderGlobalView();
    }
}

function showError(msg) {
    const el = document.getElementById('treeMapChart');
    if (el) {
        el.innerHTML = `<p style="text-align:center; padding: 2rem; color: #ff6b6b;">${msg}</p>`;
    }
}

// ----------------------------------------------------------------------
// View 1: Global Project View
// ----------------------------------------------------------------------
function renderGlobalView() {
    // Breadcrumbs
    updateBreadcrumbs([{ text: '프로젝트 목록', href: '#' }]);

    if (!allProjectsData || !Array.isArray(allProjectsData)) {
        showError('데이터 형식이 올바르지 않습니다.');
        return;
    }

    // Calculate specific risk score for each project
    const projectData = allProjectsData.map(p => {
        if (!p || !p.project) {
            console.warn('Skipping invalid project entry:', p);
            return null;
        }

        const s = p.summary || {};
        const riskScore = calculateRiskScore(s);

        // Determine name safely
        const name = p.project.name || p.project.artifactId || p.project.key || 'Unknown Project';

        return {
            x: name,
            y: riskScore,
            riskScore: riskScore,
            projectKey: p.project.key,
            totalCount: s.total || 0,
            critical: s.critical || 0,
            high: s.high || 0
        };
    })
        .filter(item => item !== null)
        .filter(item => item.y > 0); // Only show items with risk > 0

    if (projectData.length === 0) {
        showError('Risk 점수가 있는 프로젝트가 없습니다.');
        return;
    }

    // Sort by risk score desc
    projectData.sort((a, b) => b.y - a.y);
    const totalSystemRisk = projectData.reduce((acc, curr) => acc + curr.y, 0);

    const options = {
        series: [{
            data: projectData.map(item => ({
                x: item.x,
                y: item.y,
                fillColor: getRiskColor(item.riskScore)
            }))
        }],
        chart: {
            height: '100%',
            type: 'treemap',
            fontFamily: 'Inter, sans-serif',
            toolbar: { show: false },
            events: {
                dataPointSelection: function (event, chartContext, config) {
                    const dataPointIndex = config.dataPointIndex;
                    const selectedProject = projectData[dataPointIndex];
                    if (selectedProject && selectedProject.projectKey) {
                        window.location.href = `?project=${encodeURIComponent(selectedProject.projectKey)}`;
                    }
                }
            }
        },
        title: {
            text: '전체 리스크 맵 (클릭하여 상세 정보 확인)',
            align: 'center',
            style: { color: '#fff' }
        },
        colors: ['#FF3B3B', '#FF8C00', '#FFD700', '#4A9EFF'],
        plotOptions: {
            treemap: {
                distributed: true,
                enableShades: false,
                shadeIntensity: 0.5,
            }
        },
        dataLabels: {
            enabled: true,
            style: { fontSize: '14px', fontWeight: 'bold', colors: ['#ffffff'] },
            formatter: function (text, op) {
                const val = op.value;
                const percent = totalSystemRisk > 0 ? ((val / totalSystemRisk) * 100).toFixed(1) : 0;
                return [text, `${percent}%`];
            },
            offsetY: -4
        },
        tooltip: {
            theme: 'dark',
            y: {
                formatter: function (value, { dataPointIndex }) {
                    const data = projectData[dataPointIndex];
                    if (!data) return '';
                    return `
                        <div>Risk Score: <b>${value}</b></div>
                        <div>Total Vulns: ${data.totalCount}</div>
                        <div style="margin-top:4px; font-size:0.85em; color: #ff3b3b">Critical: ${data.critical}</div>
                        <div style="font-size:0.85em; color: #ff8c00">High: ${data.high}</div>
                        <div style="margin-top:6px; font-size:0.8em; color: #aaa;">Click to view details</div>
                    `;
                }
            }
        }
    };

    renderChart(options);
}

// ----------------------------------------------------------------------
// View 2: Project Detail View (Dependencies)
// ----------------------------------------------------------------------
function renderProjectDetail(projectKey) {
    if (!allProjectsData) return;

    const project = allProjectsData.find(p => p.project && p.project.key === projectKey);

    if (!project) {
        showError(`Project not found: ${escapeHtml(projectKey)}`);
        return;
    }

    const projectName = project.project.name || project.project.artifactId || 'Unknown';

    // Breadcrumbs
    updateBreadcrumbs([
        { text: '프로젝트 목록', href: 'treemap.html' },
        { text: projectName, href: '#' }
    ]);

    // Aggregate by Dependency
    const dependencyMap = new Map();

    const vulns = project.vulnerabilities || [];
    vulns.forEach(v => {
        if (!v.dependency) return;

        const depKey = `${v.dependency.groupId}:${v.dependency.artifactId}`;

        if (!dependencyMap.has(depKey)) {
            dependencyMap.set(depKey, {
                name: v.dependency.artifactId,
                groupId: v.dependency.groupId,
                version: v.dependency.version,
                vulnerabilities: []
            });
        }
        dependencyMap.get(depKey).vulnerabilities.push(v);
    });

    const depData = Array.from(dependencyMap.values()).map(dep => {
        // Calculate risk for this specific dependency
        const summary = { critical: 0, high: 0, medium: 0, low: 0 };
        dep.vulnerabilities.forEach(v => {
            if (v.cvss && v.cvss.severity) {
                const sev = v.cvss.severity.toLowerCase();
                if (summary[sev] !== undefined) summary[sev]++;
            }
        });

        const riskScore = calculateRiskScore(summary);

        return {
            x: `${dep.name} (${dep.version})`,
            y: riskScore,
            riskScore: riskScore,
            summary: summary,
            vulnCount: dep.vulnerabilities.length,
            topCve: dep.vulnerabilities[0]?.cveId // Just for info
        };
    }).filter(d => d.y > 0);

    if (depData.length === 0) {
        showError(`No vulnerable dependencies found for ${escapeHtml(projectName)}`);
        return;
    }

    depData.sort((a, b) => b.y - a.y);
    const totalProjectRisk = depData.reduce((acc, curr) => acc + curr.y, 0);

    const options = {
        series: [{
            data: depData.map(item => ({
                x: item.x,
                y: item.y,
                fillColor: getRiskColor(item.riskScore)
            }))
        }],
        chart: {
            height: '100%',
            type: 'treemap',
            fontFamily: 'Inter, sans-serif',
            toolbar: { show: false }
        },
        title: {
            text: `리스크 분석 상세: ${projectName}`,
            align: 'center',
            style: { color: '#fff' }
        },
        colors: ['#FF3B3B', '#FF8C00', '#FFD700', '#4A9EFF'],
        plotOptions: {
            treemap: {
                distributed: true,
                enableShades: false,
                shadeIntensity: 0.5,
            }
        },
        dataLabels: {
            enabled: true,
            style: { fontSize: '14px', fontWeight: 'bold', colors: ['#ffffff'] },
            formatter: function (text, op) {
                const val = op.value;
                const percent = totalProjectRisk > 0 ? ((val / totalProjectRisk) * 100).toFixed(1) : 0;
                return [text, `${percent}%`];
            },
            offsetY: -4
        },
        tooltip: {
            theme: 'dark',
            y: {
                formatter: function (value, { dataPointIndex }) {
                    const data = depData[dataPointIndex];
                    if (!data) return '';
                    return `
                        <div>Risk Score: <b>${value}</b></div>
                        <div>Vulns: ${data.vulnCount}</div>
                        <div style="margin-top:4px; font-size:0.85em; color: #ff3b3b">Critical: ${data.summary.critical}</div>
                        <div style="font-size:0.85em; color: #ff8c00">High: ${data.summary.high}</div>
                    `;
                }
            }
        }
    };

    renderChart(options);
}

// ----------------------------------------------------------------------
// Helpers
// ----------------------------------------------------------------------
function renderChart(options) {
    const el = document.getElementById('treeMapChart');
    if (!el) return;
    el.innerHTML = ''; // Clear previous
    const chart = new ApexCharts(el, options);
    chart.render();
}

function calculateRiskScore(summary) {
    if (!summary) return 0;
    return (summary.critical || 0) * 10 +
        (summary.high || 0) * 5 +
        (summary.medium || 0) * 2 +
        (summary.low || 0) * 1;
}

function getRiskColor(score) {
    if (score >= 100) return '#8B0000'; // Dark Red
    if (score >= 50) return '#FF3B3B'; // Red
    if (score >= 20) return '#FF8C00'; // Orange
    if (score >= 5) return '#FFD700'; // Yellow
    return '#4A9EFF'; // Blue
}

function updateBreadcrumbs(items) {
    // Create breadcrumb container if not exists
    let container = document.getElementById('breadcrumbs');
    if (!container) {
        const chartContainer = document.querySelector('.chart-container');
        if (chartContainer) {
            container = document.createElement('div');
            container.id = 'breadcrumbs';
            container.className = 'breadcrumbs';
            container.style.padding = '0 1rem';
            chartContainer.parentNode.insertBefore(container, chartContainer);
        }
    }

    if (container) {
        container.innerHTML = items.map((item, index) => {
            if (index === items.length - 1) {
                return `<span>${escapeHtml(item.text)}</span>`;
            }
            return `<a href="${item.href}">${escapeHtml(item.text)}</a> <span>/</span>`;
        }).join(' ');
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
