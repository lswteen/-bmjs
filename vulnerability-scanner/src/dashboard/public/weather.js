import { WeatherService } from './weather-service.js';

const weatherService = new WeatherService();

async function initWeather() {
    const loadingEl = document.getElementById('loading');
    const contentEl = document.getElementById('weatherContent');

    try {
        const data = await weatherService.fetchWeather();
        renderToday(data.current_weather);
        renderWeekly(data.daily);

        loadingEl.classList.add('hidden');
        contentEl.classList.remove('hidden');
    } catch (error) {
        loadingEl.innerHTML = `<p style="color: #fa5252;">날씨 정보를 불러오는데 실패했습니다.<br>${error.message}</p>`;
    }
}

function renderToday(current) {
    const { temperature, weathercode } = current;
    const weatherInfo = weatherService.getWeatherDescription(weathercode);

    document.getElementById('todayTemp').textContent = `${temperature}°C`;
    document.getElementById('todayDesc').textContent = weatherInfo.label;
    document.getElementById('todayIcon').innerHTML = weatherService.getIconSvg(weatherInfo.icon, 100);

    // Simple color logic for icon
    const iconSvg = document.getElementById('todayIcon').querySelector('svg');
    if (weatherInfo.icon === 'sun') iconSvg.style.color = '#ffd700';
    else if (weatherInfo.icon === 'cloud') iconSvg.style.color = '#adb5bd';
    else if (weatherInfo.icon.includes('rain')) iconSvg.style.color = '#4dabf7';
    else iconSvg.style.color = 'var(--text-primary)';
}

function renderWeekly(daily) {
    const container = document.getElementById('weeklyForecast');
    container.innerHTML = '';

    const days = ['일', '월', '화', '수', '목', '금', '토'];

    // Display 7 days
    for (let i = 0; i < 7; i++) {
        const dateStr = daily.time[i];
        const date = new Date(dateStr);
        const dayName = i === 0 ? '오늘' : days[date.getDay()];

        const maxTemp = daily.temperature_2m_max[i];
        const minTemp = daily.temperature_2m_min[i];
        const code = daily.weathercode[i];
        const weatherInfo = weatherService.getWeatherDescription(code);

        const card = document.createElement('div');
        card.className = 'day-card';
        card.innerHTML = `
            <div class="day-name">${dayName}</div>
            <div class="day-date" style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 8px;">
                ${date.getMonth() + 1}/${date.getDate()}
            </div>
            <div class="day-icon" style="color: var(--text-primary);">
                ${weatherService.getIconSvg(weatherInfo.icon, 32)}
            </div>
            <div class="day-temp">
                <span class="temp-max">${maxTemp}°</span>
                <span style="color: var(--text-tertiary)">/</span>
                <span class="temp-min">${minTemp}°</span>
            </div>
            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                ${weatherInfo.label}
            </div>
        `;
        container.appendChild(card);
    }
}

// Start
initWeather();
