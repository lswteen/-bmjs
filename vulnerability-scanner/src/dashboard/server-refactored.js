import express from 'express';
import path from 'path';
import { fileURLToPath } from 'url';
import { config } from '../core/config.js';
import fs from 'fs/promises';

// Dependency Injection Container
import { Container } from './shared/container.js';

// Routes
import { createCveRoutes } from './features/cve/routes.js';
import { createGitRoutes } from './features/git/routes.js';
import { createScanRoutes } from './features/scan/routes.js';
import { createChatbotRoutes } from './features/chatbot/routes.js';

// Middleware
import { errorHandler, requestLogger, corsHandler } from './shared/middleware/index.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const PORT = config.dashboardPort;

// Parse CLI arguments for Scanner
const args = process.argv.slice(2);
const scannerOptions = {};

for (let i = 0; i < args.length; i++) {
    if (args[i] === '--cves' && args[i + 1]) {
        scannerOptions.cveBasePath = args[i + 1];
        i++;
    } else if (args[i] === '--target' && args[i + 1]) {
        scannerOptions.projectScanPath = args[i + 1];
        i++;
    }
}

// Apply CLI overrides to config
if (scannerOptions.cveBasePath) config.cveBasePath = scannerOptions.cveBasePath;
if (scannerOptions.projectScanPath) config.projectScanPath = scannerOptions.projectScanPath;

console.log('ðŸš€ Dashboard Configuration:');
console.log(`   CVE Base Path: ${config.cveBasePath}`);
console.log(`   Project Scan Path: ${config.projectScanPath}`);
if (scannerOptions.cveBasePath) console.log(`ðŸ”§ Dashboard: Using Custom CVE Path: ${scannerOptions.cveBasePath}`);
if (scannerOptions.projectScanPath) console.log(`ðŸ”§ Dashboard: Using Custom Target Path: ${scannerOptions.projectScanPath}`);

// Initialize Dependency Injection Container
const container = new Container({
    cveBasePath: config.cveBasePath,
    projectScanPath: config.projectScanPath,
    outputPath: path.join(process.cwd(), 'output')
});

/**
 * Ensure output directory exists for scans
 */
async function ensureOutputDir() {
    const outputPath = path.join(process.cwd(), 'output');
    try {
        await fs.access(outputPath);
    } catch {
        await fs.mkdir(outputPath, { recursive: true });
        console.log('ðŸ“ Created output directory');
    }
}

ensureOutputDir();

// Middleware
app.use(express.json());
app.use(express.static(path.join(__dirname, 'public')));
app.use(requestLogger);
app.use(corsHandler);

// API Routes - Feature-based organization
app.use('/api/cves', createCveRoutes(container.getCveController()));
app.use('/api/git', createGitRoutes(container.getGitController()));
app.use('/api', createScanRoutes(container.getScanController()));
app.use('/api/chatbot', createChatbotRoutes(container.getChatbotController()));

// Legacy route compatibility (for backward compatibility)
// These can be removed once frontend is updated
app.get('/api/vllm/chat', async (req, res) => {
    try {
        const vllmService = container.getVllmService();
        const { prompt } = req.query;

        if (!prompt) {
            return res.status(400).json({ error: 'Prompt is required' });
        }

        const response = await vllmService.generateResponse(prompt);
        res.json({ response });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

app.post('/api/vllm/chat', async (req, res) => {
    try {
        const vllmService = container.getVllmService();
        const { prompt, messages } = req.body;

        if (!prompt && !messages) {
            return res.status(400).json({ error: 'Prompt or messages is required' });
        }

        const response = await vllmService.generateResponse(prompt || messages);
        res.json({ response });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// Error handling middleware (must be last)
app.use(errorHandler);

// Start server
app.listen(PORT, () => {
    console.log(`âœ… Dashboard server running at http://localhost:${PORT}`);
    console.log(`ðŸ“Š Features available:`);
    console.log(`   - CVE Explorer: /cve-explorer.html`);
    console.log(`   - CVE Severity: /cve-severity.html`);
    console.log(`   - Git Projects: /gitprojects.html`);
    console.log(`   - Chatbot: /chatbot.html`);
    console.log(`   - Vulnerability Scanner: /index.html`);
});
