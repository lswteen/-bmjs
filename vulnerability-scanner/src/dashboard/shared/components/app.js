// Global state
let allProjects = [];
let filteredProjects = [];
let currentSort = { column: null, ascending: true };
let activeCveFilters = [];

const MOCK_DATA = {
  projects: [
    {
      project: {
        name: "Ecommerce Backend",
        key: "com.example:ecommerce-backend",
        type: "maven",
        path: "/Users/dev/projects/ecommerce-backend",
        artifactId: "ecommerce-backend",
        javaVersion: "17"
      },
      vulnerabilities: [
        {
          cveId: "CVE-2023-44487",
          description: "Rapid Reset Attack vulnerability in HTTP/2 protocol functionality.",
          cvss: { severity: "CRITICAL", score: 9.8 },
          dependency: { groupId: "io.netty", artifactId: "netty-handler", version: "4.1.99.Final" },
          published: "2023-10-10",
          references: ["https://nvd.nist.gov/vuln/detail/CVE-2023-44487"]
        },
        {
          cveId: "CVE-2023-34050",
          description: "Spring AMQP Serialization Vulnerability.",
          cvss: { severity: "HIGH", score: 8.1 },
          dependency: { groupId: "org.springframework.amqp", artifactId: "spring-amqp", version: "2.4.10" },
          published: "2023-10-12",
          references: ["https://tanzu.vmware.com/security/cve-2023-34050"]
        }
      ],
      summary: { critical: 1, high: 1, medium: 2, low: 5 },
      dependencies: { direct: 45, transitive: 128 }
    },
    {
      project: {
        name: "Customer Portal",
        key: "com.example:customer-portal",
        type: "gradle",
        path: "/Users/dev/projects/customer-portal",
        artifactId: "customer-portal",
        javaVersion: "11"
      },
      vulnerabilities: [],
      summary: { critical: 0, high: 0, medium: 1, low: 3 },
      dependencies: { direct: 22, transitive: 86 }
    },
    {
      project: {
        name: "Payment Gateway Service",
        key: "com.example:payment-gateway",
        type: "maven",
        path: "/Users/dev/projects/payment-gateway",
        artifactId: "payment-service",
        javaVersion: "21"
      },
      vulnerabilities: [
        {
          cveId: "CVE-2022-1471",
          description: "SnakeYAML Constructor Remote Code Execution.",
          cvss: { severity: "CRITICAL", score: 9.9 },
          dependency: { groupId: "org.yaml", artifactId: "snakeyaml", version: "1.33" },
          published: "2022-10-12",
          references: ["https://nvd.nist.gov/vuln/detail/CVE-2022-1471"]
        }
      ],
      summary: { critical: 1, high: 0, medium: 0, low: 1 },
      dependencies: { direct: 18, transitive: 42 }
    },
    {
      project: {
        name: "Legacy Inventory System",
        key: "com.example:inventory-sys",
        type: "ant",
        path: "/Users/dev/projects/cms/inventory",
        artifactId: "inventory-core",
        javaVersion: "8"
      },
      vulnerabilities: [],
      summary: { critical: 5, high: 8, medium: 15, low: 20 },
      dependencies: { direct: 82, transitive: 250 }
    },
    {
      project: {
        name: "Auth Service",
        key: "com.example:auth-service",
        type: "maven",
        path: "/Users/dev/projects/auth-service",
        artifactId: "auth-service",
        javaVersion: "17"
      },
      vulnerabilities: [],
      summary: { critical: 0, high: 0, medium: 0, low: 0 },
      dependencies: { direct: 15, transitive: 35 }
    }
  ],
  statistics: {
    vulnerabilities: {
      totalProjects: 5,
      projectsWithVulnerabilities: 3,
      bySeverity: { critical: 7, high: 9, medium: 18, low: 29 }
    }
  }
};

// Initialize dashboard
async function init() {
  setupEventListeners();
  await loadResults();
}

// Setup event listeners
function setupEventListeners() {
  document.getElementById('scanBtn').addEventListener('click', triggerScan);
  document.getElementById('refreshBtn').addEventListener('click', loadResults);
  document.getElementById('searchInput').addEventListener('input', filterProjects);
  document.getElementById('severityFilter').addEventListener('change', filterProjects);
  document.getElementById('addCveBtn').addEventListener('click', addCveFilter);
  document.getElementById('cveInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') addCveFilter();
  });

  // Setup table sorting
  document.querySelectorAll('.sortable').forEach(th => {
    th.addEventListener('click', () => sortTable(th.dataset.sort));
  });
}

// Load scan results from API
async function loadResults() {
  try {
    showLoading(true);
    const response = await fetch('/api/results');
    const result = await response.json();


    let dataToLoad;

    if (result.success && result.data) {
      dataToLoad = result.data;
    } else {
      console.warn('Using mock data due to API failure/empty data');
      dataToLoad = MOCK_DATA;
    }

    allProjects = dataToLoad.projects || [];
    filteredProjects = [...allProjects];

    renderStats(dataToLoad.statistics);
    renderProjectsTable();

  } catch (error) {
    console.warn('Failed to load results, using mock data:', error);
    allProjects = MOCK_DATA.projects || [];
    filteredProjects = [...allProjects];
    renderStats(MOCK_DATA.statistics);
    renderProjectsTable();
  } finally {
    showLoading(false);
  }
}

// Trigger new scan
async function triggerScan() {
  const scanBtn = document.getElementById('scanBtn');

  try {
    scanBtn.disabled = true;
    scanBtn.innerHTML = '<span class="btn-icon">‚è≥</span><span class="btn-text">Scanning...</span>';

    const response = await fetch('/api/scan', { method: 'POST' });
    const result = await response.json();

    if (result.success) {
      showLoading(true);
      // Poll for completion
      await pollScanStatus();
      await loadResults();
    } else {
      alert(result.message || 'Failed to start scan');
    }
  } catch (error) {
    console.error('Scan error:', error);
    alert('Failed to start scan');
  } finally {
    scanBtn.disabled = false;
    scanBtn.innerHTML = '<span class="btn-icon">üîç</span><span class="btn-text">Run Scan</span>';
  }
}

// Poll scan status
async function pollScanStatus() {
  return new Promise((resolve) => {
    const interval = setInterval(async () => {
      try {
        const response = await fetch('/api/status');
        const status = await response.json();

        if (!status.isScanning && status.hasResults) {
          clearInterval(interval);
          resolve();
        }
      } catch (error) {
        console.error('Status poll error:', error);
      }
    }, 2000);
  });
}

// Render statistics cards
function renderStats(statistics) {
  if (!statistics || !statistics.vulnerabilities) return;

  const vulns = statistics.vulnerabilities;
  const severity = vulns.bySeverity || { critical: 0, high: 0, medium: 0, low: 0 };
  const totalVulns = (severity.critical + severity.high + severity.medium + severity.low);

  // Calculate specific metrics
  const criticalProjects = allProjects.filter(p => (p.summary && p.summary.critical > 0)).length;

  // Top Row: Key Metrics
  const statsHTML = `
    <div class="stat-card-new">
      <div class="stat-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
      </div>
      <div class="stat-content">
        <div class="stat-number">${vulns.totalProjects || 0}</div>
        <div class="stat-label-new">Total Projects</div>
      </div>
    </div>
    <div class="stat-card-new">
      <div class="stat-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
      </div>
      <div class="stat-content">
        <div class="stat-number">${vulns.projectsWithVulnerabilities || 0}</div>
        <div class="stat-label-new">Vulnerable Projects</div>
      </div>
    </div>
    <div class="stat-card-new">
      <div class="stat-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
      </div>
      <div class="stat-content">
        <div class="stat-number">${totalVulns}</div>
        <div class="stat-label-new">Total Detections</div>
      </div>
    </div>
    <div class="stat-card-new">
      <div class="stat-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
      </div>
      <div class="stat-content">
        <div class="stat-number">${criticalProjects}</div>
        <div class="stat-label-new">Critical Projects</div>
      </div>
    </div>
  `;
  document.getElementById('statsCards').innerHTML = statsHTML;

  // Middle Row: Severity Grid (MITRE Style)
  const severityHTML = `
    <div class="mitre-cell critical">
      <div class="mitre-title">CRITICAL</div>
      <div class="mitre-count">${severity.critical}</div>
    </div>
    <div class="mitre-cell high">
      <div class="mitre-title">HIGH</div>
      <div class="mitre-count">${severity.high}</div>
    </div>
    <div class="mitre-cell medium">
      <div class="mitre-title">MEDIUM</div>
      <div class="mitre-count">${severity.medium}</div>
    </div>
    <div class="mitre-cell low">
      <div class="mitre-title">LOW</div>
      <div class="mitre-count">${severity.low}</div>
    </div>
    <div class="mitre-cell">
      <div class="mitre-title">TOTAL</div>
      <div class="mitre-count">${totalVulns}</div>
    </div>
  `;
  document.getElementById('severityGrid').innerHTML = severityHTML;
}

// Render projects table
function renderProjectsTable() {
  const tbody = document.getElementById('projectsTableBody');

  if (filteredProjects.length === 0) {
    tbody.innerHTML = '<tr><td colspan="10" class="no-data">No projects found</td></tr>';
    return;
  }

  const rows = filteredProjects.map(project => {
    const p = project.project;
    const s = project.summary;
    const d = project.dependencies || { direct: 0, transitive: 0 };

    // Determine simplified status for Actions
    const hasCritical = s.critical > 0;

    return `
      <tr>
        <td title="${escapeHtml(p.path)}">
          <span class="col-path-content" style="color: var(--accent-purple);">${escapeHtml(p.path)}</span>
        </td>
        <td title="${escapeHtml(p.name)}">
          <strong style="color: var(--text-primary);" class="truncate">${escapeHtml(p.name)}</strong>
        </td>
        <td style="color: var(--text-secondary);" title="${escapeHtml(p.artifactId)}">
          <div class="truncate">${escapeHtml(p.artifactId)}</div>
        </td>
        <td style="text-align: center; color: var(--text-muted);">${d.direct}</td>
        <td style="text-align: center; color: var(--text-muted);">${d.transitive}</td>
        
        <td class="severity-col ${s.critical > 0 ? 'critical' : ''}">${s.critical || '-'}</td>
        <td class="severity-col ${s.high > 0 ? 'high' : ''}">${s.high || '-'}</td>
        <td class="severity-col ${s.medium > 0 ? 'medium' : ''}">${s.medium || '-'}</td>
        <td class="severity-col ${s.low > 0 ? 'low' : ''}">${s.low || '-'}</td>
        
        <td>
          <button class="btn btn-link" onclick="viewVulnerabilities('${escapeHtml(p.key)}')">
            View >
          </button>
        </td>
      </tr>
    `;
  }).join('');

  tbody.innerHTML = rows;
}


// Add CVE Filter
function addCveFilter() {
  const input = document.getElementById('cveInput');
  const cveId = input.value.trim().toUpperCase();

  if (!cveId) return;

  if (activeCveFilters.length >= 10) {
    alert('Maximum 10 CVE filters allowed.');
    return;
  }

  if (activeCveFilters.includes(cveId)) {
    input.value = '';
    return;
  }

  activeCveFilters.push(cveId);
  input.value = '';
  renderCveTags();
  filterProjects();
}

// Remove CVE Filter
function removeCveFilter(cveId) {
  activeCveFilters = activeCveFilters.filter(id => id !== cveId);
  renderCveTags();
  filterProjects();
}

// Render CVE Tags
function renderCveTags() {
  const container = document.getElementById('cveTags');
  container.innerHTML = activeCveFilters.map(cve => `
    <div class="cve-tag">
      <span>${escapeHtml(cve)}</span>
      <span class="remove-tag" onclick="removeCveFilter('${escapeHtml(cve)}')">&times;</span>
    </div>
  `).join('');
}

// Filter projects
function filterProjects() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const severityFilter = document.getElementById('severityFilter').value;

  filteredProjects = allProjects.filter(project => {
    // Text search
    const matchesSearch = !searchTerm ||
      project.project.name.toLowerCase().includes(searchTerm) ||
      project.project.key.toLowerCase().includes(searchTerm) ||
      (project.project.path && project.project.path.toLowerCase().includes(searchTerm));

    // CVE Filter (OR logic: if any selected CVE is present)
    // If no active filters, this passes. If filters exist, project must match at least one.
    const matchesCve = activeCveFilters.length === 0 ||
      project.vulnerabilities.some(v => activeCveFilters.some(filter => v.cveId.toUpperCase().includes(filter)));

    // Severity filter
    const matchesSeverity = !severityFilter ||
      project.summary[severityFilter] > 0;

    return matchesSearch && matchesSeverity && matchesCve;
  });

  renderProjectsTable();
}

// Sort table
function sortTable(column) {
  if (currentSort.column === column) {
    currentSort.ascending = !currentSort.ascending;
  } else {
    currentSort.column = column;
    currentSort.ascending = true;
  }

  filteredProjects.sort((a, b) => {
    let aVal, bVal;

    if (['critical', 'high', 'medium', 'low'].includes(column)) {
      aVal = a.summary[column] || 0;
      bVal = b.summary[column] || 0;
    } else if (column === 'directDeps') {
      aVal = a.dependencies?.direct || 0;
      bVal = b.dependencies?.direct || 0;
    } else if (column === 'transitiveDeps') {
      aVal = a.dependencies?.transitive || 0;
      bVal = b.dependencies?.transitive || 0;
    } else if (column === 'artifactId') {
      aVal = a.project.artifactId || '';
      bVal = b.project.artifactId || '';
    } else if (column === 'path') {
      aVal = a.project.path || '';
      bVal = b.project.path || '';
    } else {
      aVal = a.project[column] || '';
      bVal = b.project[column] || '';
    }

    if (typeof aVal === 'string') {
      aVal = aVal.toLowerCase();
      bVal = bVal.toLowerCase();
    }

    if (aVal < bVal) return currentSort.ascending ? -1 : 1;
    if (aVal > bVal) return currentSort.ascending ? 1 : -1;
    return 0;
  });

  renderProjectsTable();
}

// View vulnerabilities for a project
async function viewVulnerabilities(projectKey) {
  // Check local data first (for mock mode or speed)
  const localProject = allProjects.find(p => p.project.key === projectKey);
  if (localProject && localProject.vulnerabilities) {
    showVulnerabilityModal(projectKey, localProject.vulnerabilities);
    return;
  }

  try {
    const response = await fetch(`/api/projects/${encodeURIComponent(projectKey)}/vulnerabilities`);
    const result = await response.json();

    if (result.success) {
      showVulnerabilityModal(projectKey, result.data);
    } else {
      alert(result.message || 'Failed to load vulnerabilities');
    }
  } catch (error) {
    console.error('Error loading vulnerabilities:', error);
    alert('Failed to load vulnerabilities');
  }
}

// Show vulnerability modal
function showVulnerabilityModal(projectKey, vulnerabilities) {
  const modal = document.getElementById('vulnerabilityModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');

  modalTitle.textContent = `Vulnerabilities - ${projectKey}`;

  if (vulnerabilities.length === 0) {
    modalBody.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--text-secondary);">No vulnerabilities found for this project.</p>';
  } else {
    const vulnHTML = vulnerabilities.map(vuln => `
      <div class="vuln-item">
        <div class="vuln-header">
          <div class="vuln-id">${escapeHtml(vuln.cveId)}</div>
          <span class="severity-badge ${vuln.cvss.severity.toLowerCase()}">
            ${vuln.cvss.severity}
          </span>
        </div>
        <div class="vuln-description">${escapeHtml(vuln.description)}</div>
        <div class="vuln-meta">
          <div class="meta-item">
            <span class="meta-label">CVSS Score</span>
            <span class="meta-value cvss-score" style="color: ${getSeverityColor(vuln.cvss.severity)}">
              ${vuln.cvss.score}
            </span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Dependency</span>
            <span class="meta-value">
              <code>${escapeHtml(vuln.dependency.groupId)}:${escapeHtml(vuln.dependency.artifactId)}:${escapeHtml(vuln.dependency.version)}</code>
            </span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Published</span>
            <span class="meta-value">${formatDate(vuln.published)}</span>
          </div>
          ${vuln.cwes && vuln.cwes.length > 0 ? `
            <div class="meta-item">
              <span class="meta-label">CWE</span>
              <span class="meta-value">${vuln.cwes.join(', ')}</span>
            </div>
          ` : ''}
        </div>
        ${vuln.references && vuln.references.length > 0 ? `
          <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
            <span class="meta-label">References:</span>
            <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
              ${vuln.references.slice(0, 3).map(ref => `
                <li><a href="${escapeHtml(ref)}" target="_blank" style="color: #667eea; text-decoration: none;">${escapeHtml(ref)}</a></li>
              `).join('')}
            </ul>
          </div>
        ` : ''}
      </div>
    `).join('');

    modalBody.innerHTML = vulnHTML;
  }

  modal.classList.remove('hidden');
}

// Close modal
function closeModal() {
  document.getElementById('vulnerabilityModal').classList.add('hidden');
}

// Close modal when clicking outside
window.addEventListener('click', (e) => {
  const modal = document.getElementById('vulnerabilityModal');
  if (e.target === modal) {
    closeModal();
  }
});

// Utility functions
function showLoading(show) {
  const loading = document.getElementById('loading');
  if (show) {
    loading.classList.remove('hidden');
  } else {
    loading.classList.add('hidden');
  }
}

function showNoData(message) {
  document.getElementById('statsCards').innerHTML = '';
  document.getElementById('projectsTableBody').innerHTML =
    `<tr><td colspan="10" class="no-data">${escapeHtml(message)}</td></tr>`;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function getSeverityColor(severity) {
  const colors = {
    CRITICAL: '#ff3b3b',
    HIGH: '#ff8c00',
    MEDIUM: '#ffd700',
    LOW: '#4a9eff'
  };
  return colors[severity.toUpperCase()] || '#a0a0a0';
}

function formatDate(dateString) {
  if (!dateString || dateString === 'Unknown') return 'Unknown';
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'short', day: 'numeric' });
  } catch {
    return dateString;
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', init);
