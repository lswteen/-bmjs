/**
 * Dependency Injection Container
 * Manages dependencies and creates instances following IoC pattern
 */
import { Scanner } from '../../../bin/scanner.js';
import { CveDb } from '../../service/cve-service.js';
import { SyncProjectsUseCase } from '../../application/git/sync-projects-use-case.js';

// Controllers
import { CveController } from '../features/cve/controllers/CveController.js';
import { GitController } from '../features/git/controllers/GitController.js';
import { ScanController } from '../features/scan/controllers/ScanController.js';
import { ChatbotController } from '../features/chatbot/controllers/ChatbotController.js';

// Services
import { CveService } from '../features/cve/services/CveService.js';
import { GitService } from '../features/git/services/GitService.js';
import { ScanService } from '../features/scan/services/ScanService.js';
import { ChatbotService } from '../features/chatbot/services/ChatbotService.js';

// Repositories
import { CveRepository } from '../features/cve/repositories/CveRepository.js';
import { GitRepository } from '../features/git/repositories/GitRepository.js';

// External services
import { VllmService } from '../../service/vllm-service.js';

export class Container {
    constructor(config) {
        this.config = config;
        this.instances = new Map();
    }

    /**
     * Get or create singleton instance
     * @param {string} key - Instance key
     * @param {Function} factory - Factory function to create instance
     * @returns {*}
     */
    singleton(key, factory) {
        if (!this.instances.has(key)) {
            this.instances.set(key, factory());
        }
        return this.instances.get(key);
    }

    /**
     * Get CVE Database instance
     * @returns {CveDb}
     */
    getCveDb() {
        return this.singleton('cveDb', () => new CveDb(this.config.cveBasePath));
    }

    /**
     * Get Scanner instance
     * @returns {Scanner}
     */
    getScanner() {
        return this.singleton('scanner', () => {
            const options = {
                cveBasePath: this.config.cveBasePath,
                projectScanPath: this.config.projectScanPath
            };
            return new Scanner(options);
        });
    }

    /**
     * Get vLLM Service instance
     * @returns {VllmService}
     */
    getVllmService() {
        return this.singleton('vllmService', () => new VllmService());
    }

    /**
     * Get Sync Projects Use Case
     * @returns {SyncProjectsUseCase}
     */
    getSyncUseCase() {
        return this.singleton('syncUseCase', () => new SyncProjectsUseCase());
    }

    // Repositories

    /**
     * Get CVE Repository
     * @returns {CveRepository}
     */
    getCveRepository() {
        return this.singleton('cveRepository', () =>
            new CveRepository(this.getCveDb())
        );
    }

    /**
     * Get Git Repository
     * @returns {GitRepository}
     */
    getGitRepository() {
        return this.singleton('gitRepository', () =>
            new GitRepository(this.getCveDb())
        );
    }

    // Services

    /**
     * Get CVE Service
     * @returns {CveService}
     */
    getCveService() {
        return this.singleton('cveService', () =>
            new CveService(this.getCveRepository())
        );
    }

    /**
     * Get Git Service
     * @returns {GitService}
     */
    getGitService() {
        return this.singleton('gitService', () =>
            new GitService(this.getGitRepository(), this.getSyncUseCase())
        );
    }

    /**
     * Get Scan Service
     * @returns {ScanService}
     */
    getScanService() {
        return this.singleton('scanService', () =>
            new ScanService(this.getScanner(), this.config.outputPath)
        );
    }

    /**
     * Get Chatbot Service
     * @returns {ChatbotService}
     */
    getChatbotService() {
        return this.singleton('chatbotService', () =>
            new ChatbotService(this.getVllmService(), this.getCveRepository())
        );
    }

    // Controllers

    /**
     * Get CVE Controller
     * @returns {CveController}
     */
    getCveController() {
        return this.singleton('cveController', () =>
            new CveController(this.getCveService())
        );
    }

    /**
     * Get Git Controller
     * @returns {GitController}
     */
    getGitController() {
        return this.singleton('gitController', () =>
            new GitController(this.getGitService())
        );
    }

    /**
     * Get Scan Controller
     * @returns {ScanController}
     */
    getScanController() {
        return this.singleton('scanController', () =>
            new ScanController(this.getScanService())
        );
    }

    /**
     * Get Chatbot Controller
     * @returns {ChatbotController}
     */
    getChatbotController() {
        return this.singleton('chatbotController', () =>
            new ChatbotController(this.getChatbotService())
        );
    }
}
