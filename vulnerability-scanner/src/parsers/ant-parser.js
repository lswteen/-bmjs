import fs from 'fs/promises';
import path from 'path';
import { XMLParser } from 'fast-xml-parser';
import { findFiles } from '../file-utils.js';

/**
 * Parser for Ant build.xml files
 */
export class AntParser {
    constructor() {
        this.parser = new XMLParser({
            ignoreAttributes: false,
            attributeNamePrefix: '@_'
        });
    }

    /**
     * Parse build.xml and scan for dependencies
     */
    async parse(filePath) {
        try {
            const content = await fs.readFile(filePath, 'utf8');
            const xml = this.parser.parse(content);
            const project = xml.project || {};
            const projectDir = path.dirname(filePath);

            // Extract metadata
            const name = project['@_name'] || path.basename(projectDir);
            const javaVersion = this.extractJavaVersion(project);

            // Scan for jar files to identify dependencies
            // Ant doesn't have a standard dependency file, so we scan libs
            const dependencies = await this.scanForJars(projectDir);

            return {
                name: name,
                groupId: 'unknown', // Ant doesn't strictly have groupId
                artifactId: name,   // Use project name as artifactId
                version: '0.0.0',   // Default version
                type: 'ant',
                javaVersion: javaVersion,
                path: projectDir,
                buildFile: 'build.xml',
                dependencies: dependencies
            };
        } catch (error) {
            console.warn(`Error parsing ${filePath}: ${error.message}`);
            return null;
        }
    }

    /**
     * Extract Java version from javac target/source
     */
    extractJavaVersion(project) {
        // Look for javac task parameters
        // This is a simplified check; real Ant files can be complex
        if (project.javac) {
            const target = project.javac['@_target'] || project.javac['@_source'];
            if (target) return target;
        }

        // Check properties
        if (project.property) {
            const properties = Array.isArray(project.property) ? project.property : [project.property];
            const targetProp = properties.find(p => p['@_name'] === 'ant.build.javac.target');
            if (targetProp) return targetProp['@_value'];
        }

        return 'unknown';
    }

    /**
     * Scan project directory for .jar files
     */
    async scanForJars(projectDir) {
        const dependencies = [];
        // Find all .jar files in the project directory
        // We exclude common build output directories to avoid duplicates
        const jarFiles = await findFiles(projectDir, '*.jar');

        for (const jarPath of jarFiles) {
            // Skip jars in build/target directories if possible, but for now we include them
            // as Ant structures vary wildly.

            const filename = path.basename(jarPath);
            const dep = this.parseJarFilename(filename);

            if (dep) {
                dependencies.push(dep);
            }
        }

        return dependencies;
    }

    /**
     * Parse jar filename to extract artifactId and version
     * e.g., commons-lang3-3.12.0.jar -> artifactId: commons-lang3, version: 3.12.0
     */
    parseJarFilename(filename) {
        // Remove .jar extension
        const name = filename.replace(/\.jar$/, '');

        // Try to find version number (starts with digit)
        // Regex: look for - followed by digit
        const match = name.match(/-((\d+\.)+\d+.*)$/);

        if (match) {
            const version = match[1];
            const artifactId = name.substring(0, match.index);

            return {
                groupId: 'unknown', // Cannot reliably determine groupId from filename
                artifactId: artifactId,
                version: version,
                scope: 'compile' // Assume compile scope
            };
        }

        // If no version found, use whole name as artifactId
        return {
            groupId: 'unknown',
            artifactId: name,
            version: 'unknown',
            scope: 'compile'
        };
    }
}
