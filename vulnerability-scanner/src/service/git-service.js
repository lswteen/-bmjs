import { config } from '../core/config.js';

/**
 * Service to interact with the Git Repository API (Bitbucket/Stash)
 */
export class GitService {
    constructor() {
        this.projectApiUrl = config.gitApiUrl || 'https://git.lottecard.com/rest/api/1.0/projects';
        this.reposApiUrl = 'https://git.lottecard.com/rest/api/1.0/repos';
    }

    /**
     * Fetch repositories across all projects in a paged manner
     * GET /rest/api/1.0/repos
     */
    async fetchReposPaged(start = 0, limit = 25) {
        const isInternal = this.reposApiUrl.includes('lottecard.com');
        if (process.env.USE_MOCK_GIT || !isInternal) {
            console.log('ðŸ“¡ GitService: Using mock repository data (paged)');
            const allMockProjects = this.getMockProjects();
            const allMockRepos = [];
            for (const p of allMockProjects) {
                const repos = this.getMockRepos(p.key);
                repos.forEach(r => allMockRepos.push({ ...r, project: p }));
            }
            const rows = allMockRepos.slice(start, start + limit);
            return {
                values: rows,
                size: rows.length,
                limit: limit,
                isLastPage: start + limit >= allMockRepos.length,
                start: start,
                nextPageStart: start + limit < allMockRepos.length ? start + limit : null
            };
        }

        try {
            const response = await fetch(`${this.reposApiUrl}?start=${start}&limit=${limit}`, {
                timeout: 10000,
                headers: {
                    'Authorization': 'Basic fafarcoder dmfwlfh5rk!@'
                }
            });

            if (!response.ok) {
                throw new Error(`Git Repos API error: ${response.statusText}`);
            }

            return await response.json();
        } catch (error) {
            console.warn(`âš ï¸ Git Repos API fetch failed: ${error.message}. Returning empty paged result.`);
            return { values: [], size: 0, limit, isLastPage: true, start };
        }
    }

    /**
     * Fetch all projects from the Git API
     * Handles pagination (25 items per page)
     */
    async fetchAllProjects() {
        // For local development/testing where the internal URL is unreachable
        // We use the mock data provided by the user. 
        const isInternal = this.projectApiUrl.includes('lottecard.com');
        if (process.env.USE_MOCK_GIT || !isInternal) {
            console.log('ðŸ“¡ GitService: Using mock project data');
            return this.getMockProjects();
        }

        try {
            let allValues = [];
            let isLastPage = false;
            let start = 0;
            const limit = 25;

            while (!isLastPage) {
                const response = await fetch(`${this.projectApiUrl}?start=${start}&limit=${limit}`, {
                    timeout: 5000, // 5 seconds timeout
                    headers: {
                        'Authorization': 'Basic fafarcoder dmfwlfh5rk!@'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Git API error: ${response.statusText}`);
                }

                const data = await response.json();
                allValues = allValues.concat(data.values || []);

                isLastPage = data.isLastPage;
                if (!isLastPage && data.nextPageStart) {
                    start = data.nextPageStart;
                } else if (!isLastPage) { // Fallback for safety
                    start += limit;
                }
            }

            return allValues;
        } catch (error) {
            console.warn(`âš ï¸ Git API fetch failed: ${error.message}. Falling back to mock data.`);
            return this.getMockProjects();
        }
    }

    /**
     * Fetch repositories for a specific project
     */
    async fetchReposForProject(projectKey) {
        const isInternal = (config.gitRepoApiUrl || '').includes('lottecard.com');
        if (process.env.USE_MOCK_GIT || !isInternal) {
            return this.getMockRepos(projectKey);
        }

        try {
            const repoUrl = config.gitRepoApiUrl
                ? config.gitRepoApiUrl.replace('{projectKey}', projectKey)
                : `${this.projectApiUrl}/${projectKey}/repos`;

            const response = await fetch(repoUrl, {
                timeout: 5000,
                headers: {
                    'Authorization': 'Basic fafarcoder dmfwlfh5rk!@'
                }
            });
            if (!response.ok) throw new Error(`Git Repo API error: ${response.statusText}`);
            const data = await response.json();
            return data.values || [];
        } catch (error) {
            console.warn(`âš ï¸ Git Repo fetch failed for ${projectKey}: ${error.message}. Returning mock data.`);
            return this.getMockRepos(projectKey);
        }
    }

    /**
     * Mock data provided by the user for testing (Exactly 20 items)
     */
    getMockProjects() {
        return [
            { "key": "ANLAPI", "id": 1237, "name": "ANLAPI", "description": "ë¡¯ë°ì¹´ë“œ ë¶„ì„API" },
            { "key": "CCC", "id": 1294, "name": "Cloud Contact Center", "description": "ë¡¯ë°ì¹´ë“œ CCC" },
            { "key": "CRED", "id": 51, "name": "CreditPlus", "description": "í¬ë ˆë”§ í”ŒëŸ¬ìŠ¤ ì•± - [ì±„ë„ê³„]" },
            { "key": "ELAPP", "id": 106, "name": "ELApp", "description": "ì „ìžëŒ€ì¶œì•½ì •ì„œ - [ì±„ë„ê³„]" },
            { "key": "ELA", "id": 110, "name": "ELApplication", "description": "ì „ìžëŒ€ì¶œì‹ ì²­ì„œ - [ì±„ë„ê³„]" },
            { "key": "ER", "id": 99, "name": "ER-Erms", "description": "LPì´ê´€-ì´ë©”ì¼ìƒë‹´ - [ì±„ë„ê³„]" },
            { "key": "EZA", "id": 52, "name": "EZApplication", "description": "EZì‹ ì²­ì„œ (ì „ìžê°€ìž…ì‹ ì²­ì„œ) ì•± - [ì±„ë„ê³„]" },
            { "key": "GENAIPLATFORM", "id": 1782, "name": "genai-platform", "description": "ìƒì„±í˜•AI í”Œëž«í¼" },
            { "key": "GENAIDIKU", "id": 1861, "name": "genai-platform-dataiku", "description": "ìƒì„±í˜• AI í”Œëž«í¼ í”„ë¡œì íŠ¸" },
            { "key": "IBSS", "id": 1423, "name": "ibss", "description": "IBSS - ITìš´ì˜íŒ€" },
            { "key": "LOCA2", "id": 472, "name": "LOCA-2.0-Client", "description": "ë¡¯ë°ì¹´ë“œ ì•± SPA" },
            { "key": "LCCN", "id": 834, "name": "loca-cloud-native", "description": "ì„œë¹„ìŠ¤ê²½ëŸ‰í™” í”„ë¡œì íŠ¸" },
            { "key": "LOCAFRBACKEND", "id": 1716, "name": "LOCA-FOREIGNER-PREPAID-Backend", "description": "" },
            { "key": "LCFRPR", "id": 1707, "name": "LOCA-FOREIGNER-PREPAID-Client", "description": "ë¡¯ë°ì¹´ë“œ - ì™¸êµ­ì¸ì„ ë¶ˆì¹´ë“œ" },
            { "key": "AICVB", "id": 1683, "name": "LotteCard AIVoicebot", "description": "AIë³´ì´ìŠ¤ë´‡ êµ¬ì¶• í”„ë¡œì íŠ¸" },
            { "key": "LCALM", "id": 134, "name": "LotteCard ALM", "description": "ë¡¯ë°ì¹´ë“œ ALM - [ë ˆê±°ì‹œ-ê²½ì˜ì •ë³´]" },
            { "key": "LCAML", "id": 150, "name": "LotteCard AML", "description": "ë¡¯ë°ì¹´ë“œ AML - [ë ˆê±°ì‹œ-ì‹¬ì‚¬]" },
            { "key": "LCAPP", "id": 43, "name": "LotteCard App", "description": "ë¡¯ë°ì¹´ë“œ ì•± - [ì±„ë„ê³„]" },
            { "key": "LCAPPC", "id": 44, "name": "LotteCard AppCard", "description": "ë¡¯ë°ì¹´ë“œ ì•±ì¹´ë“œ ì•± - [ì±„ë„ê³„]" },
            { "key": "LCARCH", "id": 146, "name": "LotteCard Archiving", "description": "ë¡¯ë°ì¹´ë“œ ì²­êµ¬ì„œì•„ì¹´ì´ë¹™ - [ë ˆê±°ì‹œ-ì²­êµ¬ì„œ]" }
        ];
    }

    /**
     * Mock repositories for a project
     */
    getMockRepos(projectKey) {
        if (projectKey === 'ANLAPI') {
            return [
                { "slug": "cufit_psnl_prd_rec", "id": 990, "name": "CUFIT_PSNL_PRD_REC", "description": "" },
                { "slug": "eng_psnl_odr", "id": 971, "name": "ENG_PSNL_ODR", "description": "ì—°ê³„ ì¶”ì²œ ì„œë¹„ìŠ¤" },
                { "slug": "lcl_svc_psnl_rec", "id": 989, "name": "LCL_SVC_PSNL_REC", "description": "" },
                { "slug": "mmf_psnl_odr", "id": 965, "name": "MMF_PSNL_ODR", "description": "ë©”ì¸í”¼ë“œ ì„œë¹„ìŠ¤" },
                { "slug": "mmk_cd_rcmd", "id": 964, "name": "MMK_CD_RCMD", "description": "ì¹´ë“œì¶”ì²œ ì„œë¹„ìŠ¤" },
                { "slug": "myd2_psnl_odr", "id": 972, "name": "MYD2_PSNL_ODR", "description": "ë§ˆì´ë°ì´í„° ì„œë¹„ìŠ¤" },
                { "slug": "tch_psnl_odr", "id": 967, "name": "TCH_PSNL_ODR", "description": "í„°ì¹˜ ì„œë¹„ìŠ¤" },
                { "slug": "thg_psnl_scr", "id": 966, "name": "THG_PSNL_SCR", "description": "ëµíƒ­ ì„œë¹„ìŠ¤" },
                { "slug": "thg_shop_psnl_rec", "id": 988, "name": "THG_SHOP_PSNL_REC", "description": "" }
            ];
        }

        // Generic mock for other projects
        return [
            { "slug": "api-gateway", "id": 1, "name": `${projectKey}_API_GATEWAY`, "description": "Core API Gateway Service" },
            { "slug": "auth-service", "id": 2, "name": `${projectKey}_AUTH_SERVICE`, "description": "Authentication & Authorization" },
            { "slug": "web-portal", "id": 3, "name": `${projectKey}_WEB_PORTAL`, "description": "Customer Portal Interface" }
        ];
    }
}
