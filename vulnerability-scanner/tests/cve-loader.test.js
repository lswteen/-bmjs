import { jest } from '@jest/globals';
import { CVELoader } from '../src/cve-loader.js';

describe('CVELoader', () => {
    let loader;

    beforeEach(() => {
        loader = new CVELoader();
    });

    describe('normalizeCVE', () => {
        it('should correctly extract CVSS v3.1 score and severity', () => {
            const rawCVE = {
                cveMetadata: { cveId: 'CVE-2025-1234', datePublished: '2025-01-01' },
                containers: {
                    cna: {
                        metrics: [
                            {
                                cvssV3_1: {
                                    baseScore: 9.8,
                                    baseSeverity: 'CRITICAL',
                                    vectorString: 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H'
                                }
                            }
                        ],
                        descriptions: [{ value: 'Test Description' }]
                    }
                }
            };

            const result = loader.normalizeCVE(rawCVE);
            expect(result.cvss.score).toBe(9.8);
            expect(result.cvss.severity).toBe('CRITICAL');
        });

        it('should correctly extract CVSS v4.0 score', () => {
            const rawCVE = {
                cveMetadata: { cveId: 'CVE-2025-5678', datePublished: '2025-01-01' },
                containers: {
                    cna: {
                        metrics: [
                            {
                                cvssV4_0: {
                                    baseScore: 10.0,
                                    baseSeverity: 'CRITICAL',
                                    vectorString: 'CVSS:4.0/...'
                                }
                            }
                        ],
                        descriptions: [{ value: 'Test V4' }]
                    }
                }
            };

            const result = loader.normalizeCVE(rawCVE);
            expect(result.cvss.score).toBe(10.0);
            expect(result.cvss.severity).toBe('CRITICAL');
        });

        it('should handle complex metrics array where first element is NOT score', () => {
            // This reproduces the bug we fixed
            const rawCVE = {
                cveMetadata: { cveId: 'CVE-2025-BUG', datePublished: '2025-01-01' },
                containers: {
                    cna: {
                        metrics: [
                            { other: { type: 'Textual description', content: { text: 'critical' } } },
                            {
                                cvssV3_1: {
                                    baseScore: 8.4,
                                    baseSeverity: 'HIGH'
                                }
                            }
                        ],
                        descriptions: [{ value: 'Complex Metrics' }]
                    }
                }
            };

            const result = loader.normalizeCVE(rawCVE);
            expect(result.cvss.score).toBe(8.4);
            expect(result.cvss.severity).toBe('HIGH');
        });

        it('should return 0 score when no metrics found', () => {
            const rawCVE = {
                cveMetadata: { cveId: 'CVE-NO-METRICS', datePublished: '2025-01-01' },
                containers: {
                    cna: {
                        descriptions: [{ value: 'No metrics' }]
                    }
                }
            };

            const result = loader.normalizeCVE(rawCVE);
            expect(result.cvss.score).toBe(0);
            expect(result.cvss.severity).toBe('NONE'); // calculateSeverity(0) returns NONE (usually)
        });
    });
});
