import { jest } from '@jest/globals';
import { SyncGitProjectsUseCase } from '../src/application/git/sync-projects-use-case.js';

describe('SyncGitProjectsUseCase', () => {
    let mockGitClient;
    let mockPersistence;
    let useCase;

    beforeEach(() => {
        mockGitClient = {
            fetchReposPaged: jest.fn()
        };
        mockPersistence = {
            syncProjects: jest.fn(),
            syncRepos: jest.fn()
        };
        useCase = new SyncGitProjectsUseCase(mockGitClient, mockPersistence);
    });

    test('should sync projects and repos in pages', async () => {
        // Mock paged response
        mockGitClient.fetchReposPaged.mockResolvedValueOnce({
            values: [
                {
                    slug: 'repo1', id: 1, name: 'Repo1',
                    project: { key: 'P1', id: 10, name: 'Proj1' }
                }
            ],
            isLastPage: true
        });

        const result = await useCase.execute();

        expect(result.totalProjectsSynced).toBe(1);
        expect(result.totalReposSynced).toBe(1);
        expect(mockPersistence.syncProjects).toHaveBeenCalledTimes(1);
        expect(mockPersistence.syncRepos).toHaveBeenCalledTimes(1);
    });
});
