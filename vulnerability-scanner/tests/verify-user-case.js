
import { CVELoader } from './src/cve-loader.js';
import { VulnerabilityMatcher } from './src/matcher.js';

async function verify() {
    console.log("ðŸ” Verifying User Scenario...");

    // 1. Mock CVE Data (based on user provided JSON)
    const mockCVE = {
        cveMetadata: { cveId: 'CVE-2025-54988' },
        containers: {
            cna: {
                affected: [
                    {
                        packageName: "org.apache.tika:tika-parser-pdf-module",
                        product: "Apache Tika PDF parser module",
                        vendor: "Apache Software Foundation",
                        versions: [
                            {
                                lessThanOrEqual: "3.2.1",
                                status: "affected",
                                version: "1.13",
                                versionType: "semver"
                            }
                        ]
                    }
                ]
            }
        }
    };

    // 2. Setup Crawler/Matcher
    const loader = new CVELoader();
    const matcher = new VulnerabilityMatcher(loader);

    // Normalize the CVE immediately to test our parsing logic
    const normalizedCVE = loader.normalizeCVE(mockCVE);

    console.log("âœ… Normalized CVE Versions:", JSON.stringify(normalizedCVE.affected[0].versions, null, 2));

    // 3. Define Test Dependencies
    const testCases = [
        // Case A: Correct match (Inclusive upper bound)
        {
            groupId: 'org.apache.tika',
            artifactId: 'tika-parser-pdf-module',
            version: '3.2.1',
            expected: true,
            desc: 'Target Version 3.2.1 (Should Match)'
        },
        // Case B: Typo in artifactId
        {
            groupId: 'org.apache.tika',
            artifactId: 'tica-core',
            version: '3.2.1',
            expected: false,
            desc: 'Typo "tica-core" (Should NOT Match)'
        },
        // Case C: Version above range
        {
            groupId: 'org.apache.tika',
            artifactId: 'tika-parser-pdf-module',
            version: '3.2.2',
            expected: false,
            desc: 'Version 3.2.2 (Should NOT Match)'
        }
    ];

    // 4. Run Tests
    for (const test of testCases) {
        const dep = {
            groupId: test.groupId,
            artifactId: test.artifactId,
            version: test.version
        };

        const isMatch = matcher.isMatch(dep, normalizedCVE.affected[0]);
        const resultIcon = isMatch === test.expected ? 'âœ…' : 'âŒ';

        console.log(`${resultIcon} [${test.desc}] -> Matched: ${isMatch}`);
    }
}

verify().catch(console.error);
